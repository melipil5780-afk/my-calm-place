<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindPath - Complete Mindfulness Training</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
       
        * {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
       
        body {
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
        }
       
        /* Improved contrast */
        .skill-card h4 {
            color: #1f2937 !important;
        }
       
        .action-button {
            color: white !important;
            font-weight: 700 !important;
        }
       
        /* ANTI-FREEZE FIX: Textarea optimization */
        textarea.no-freeze {
            will-change: contents;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            font-size: 16px !important;
            background: white !important;
            color: #1f2937 !important;
            border: 2px solid #d1d5db !important;
        }
       
        textarea.no-freeze:focus {
            border-color: #7c3aed !important;
            outline: none !important;
        }
        
        input[type="text"], input[type="range"] {
            background: white !important;
            color: #1f2937 !important;
            border: 2px solid #d1d5db !important;
            font-size: 16px !important;
        }
       
        input[type="text"]:focus, input[type="range"]:focus {
            border-color: #7c3aed !important;
            outline: none !important;
        }
       
        .bottom-nav {
            padding-bottom: env(safe-area-inset-bottom);
            background: #ffffff;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            border-top: 1px solid #e5e7eb;
        }
       
        .nav-badge {
            position: absolute;
            top: 0px;
            right: 12px;
            background: #dc2626;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 12px;
            min-width: 20px;
            height: 20px;
            text-align: center;
            line-height: 1;
            border: 2px solid white;
        }
       
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
       
        .glow {
            box-shadow: 0 4px 25px rgba(139, 92, 246, 0.2);
        }
       
        .glow:hover {
            box-shadow: 0 8px 35px rgba(139, 92, 246, 0.3);
        }
       
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
       
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
       
        @keyframes coin-pop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
       
        .animate-coin-pop {
            animation: coin-pop 0.8s ease-out;
        }
       
        /* Theme backgrounds */
        .theme-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #db2777 100%);
        }
       
        .theme-ocean {
            background: linear-gradient(135deg, #1e40af 0%, #0ea5e9 50%, #22d3ee 100%);
        }
       
        .theme-sunset {
            background: linear-gradient(135deg, #dc2626 0%, #ea580c 50%, #f59e0b 100%);
        }
       
        .theme-forest {
            background: linear-gradient(135deg, #065f46 0%, #10b981 50%, #34d399 100%);
        }
       
        .theme-midnight {
            background: linear-gradient(135deg, #1e1b4b 0%, #3730a3 50%, #6366f1 100%);
        }
       
        .theme-rose {
            background: linear-gradient(135deg, #be185d 0%, #db2777 50%, #f472b6 100%);
        }
       
        /* Glass effects */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
       
        .glass-dark {
            background: rgba(15, 23, 42, 0.92);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
       
        /* Mobile-friendly touch targets */
        button, .clickable {
            min-height: 44px;
            min-width: 44px;
        }
       
        /* Purchase confirmation animation */
        @keyframes purchase-confirm {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
       
        .purchase-confirm {
            animation: purchase-confirm 0.5s ease-out;
        }
       
        /* Improved slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            height: 10px;
            border-radius: 5px;
            background: #e5e7eb;
        }
       
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #7c3aed;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
       
        /* Safe area for notches */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
       
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
       
        /* Prevent horizontal scroll */
        .no-horizontal-scroll {
            max-width: 100%;
            overflow-x: hidden;
        }
       
        /* Responsive text sizes */
        @media (max-width: 380px) {
            .text-responsive {
                font-size: 0.9rem;
            }
           
            .text-responsive-lg {
                font-size: 1.1rem;
            }
           
            .text-responsive-xl {
                font-size: 1.3rem;
            }
        }

        /* NEW: Checkbox styling */
        .practice-checkbox {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px dashed #d1d5db;
            background: #f3f4f6;
        }
       
        .practice-checkbox.checked {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            border: 2px solid #10b981;
        }
       
        /* NEW: Timer animation */
        @keyframes pulse-timer {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        .timer-pulse {
            animation: pulse-timer 2s infinite;
        }
        
        /* NEW: Fade transitions */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* NEW: Special skill colors */
        .skill-observe { background: linear-gradient(135deg, #8b5cf6, #db2777); }
        .skill-describe { background: linear-gradient(135deg, #2563eb, #06b6d4); }
        .skill-participate { background: linear-gradient(135deg, #059669, #10b981); }
        .skill-nonjudgment { background: linear-gradient(135deg, #ea580c, #dc2626); }
        .skill-onemindfully { background: linear-gradient(135deg, #4f46e5, #7c3aed); }
        .skill-effectively { background: linear-gradient(135deg, #db2777, #f472b6); }
        .skill-checkin { background: linear-gradient(135deg, #0d9488, #22d3ee); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen no-horizontal-scroll"></div>
    
    <!-- Purchase Notification Modal -->
    <div id="purchaseModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="z-index: 9999;">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="relative bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl purchase-confirm">
            <div class="text-center">
                <div class="text-6xl mb-4">üéâ</div>
                <h3 class="text-xl font-bold text-gray-800 mb-3" id="purchaseTitle"></h3>
                <p class="text-gray-600 mb-6 text-sm" id="purchaseMessage"></p>
                <button onclick="closePurchaseModal()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-2xl font-bold text-lg shadow-lg">
                    Awesome!
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ====== PHASE 4: COMPLETE MIGRATION - ALL 7 SKILLS ======
        
        // ====== ANTI-FREEZE SOLUTION ======
        let textareaCache = {};
        let renderTimeout = null;
        
        // ====== PERSISTENT STORAGE ======
        function saveState() {
            localStorage.setItem('mindpath_state', JSON.stringify(state));
            localStorage.setItem('mindpath_journal', JSON.stringify(journalEntries));
            localStorage.setItem('mindpath_practice_tracker', JSON.stringify(practiceTracker));
            localStorage.setItem('mindpath_daily_checkin', JSON.stringify(dailyCheckin));
            localStorage.setItem('mindpath_achievements', JSON.stringify(achievements));
        }

        function loadState() {
            const savedState = localStorage.getItem('mindpath_state');
            const savedJournal = localStorage.getItem('mindpath_journal');
            const savedPractice = localStorage.getItem('mindpath_practice_tracker');
            const savedCheckin = localStorage.getItem('mindpath_daily_checkin');
            const savedAchievements = localStorage.getItem('mindpath_achievements');
            
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state = { ...state, ...parsed };
                updateDailyStreak();
            }
            
            if (savedJournal) journalEntries = JSON.parse(savedJournal);
            if (savedPractice) practiceTracker = JSON.parse(savedPractice);
            if (savedCheckin) dailyCheckin = JSON.parse(savedCheckin);
            if (savedAchievements) achievements = JSON.parse(savedAchievements);
        }

        // ====== ENHANCED STATE ======
        let state = {
            coins: 1000, // Increased for testing
            user: {
                avatar: 'üòä',
                theme: 'gradient',
                level: 1,
                xp: 0,
                streak: 0,
                totalPractices: 0,
                name: 'Mindful Explorer',
                lastPracticeDate: null,
                consecutiveDays: 0,
                comboMultiplier: 1
            },
            activeSkill: null,
            currentStep: 'intro',
            worksheetData: {},
            showCoinAnimation: false,
            coinAmount: 0,
            screen: 'home',
            completedSkills: [],
            inventory: {
                themes: ['gradient'],
                avatars: ['üòä'],
                badges: []
            },
            unreadShopItems: 3,
            purchaseHistory: [],
            lastPurchase: null
        };

        // ====== NEW FEATURES DATA ======
        let journalEntries = [];
        let practiceTracker = {};
        let dailyCheckin = {
            lastCheckin: null,
            streak: 0
        };
        let achievements = {
            firstBadge: false,
            fiveSkills: false,
            tenDays: false,
            masterCombo: false
        };

        // ====== TIMER VARIABLES ======
        let timerInterval = null;
        let practiceTimerInterval = null;
        let practicePromptIndex = 0;

        // ====== ANIMATION FUNCTIONS ======
        function triggerConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        function triggerAchievementConfetti() {
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 }
            });
        }

        // ====== COIN ANIMATION RENDER ======
        function renderCoinAnimation() {
            return `
                <div class="fixed inset-0 pointer-events-none flex items-center justify-center z-50">
                    <div class="animate-coin-pop text-center">
                        <div class="text-7xl mb-3">ü™ô</div>
                        <div class="text-4xl font-black text-yellow-400">+${state.coinAmount}</div>
                        <p class="text-xl text-white mt-3 font-bold">Coins Earned!</p>
                    </div>
                </div>
            `;
        }

        // ====== DAILY STREAK SYSTEM ======
        function updateDailyStreak() {
            const today = new Date().toDateString();
            const lastDate = state.user.lastPracticeDate ? new Date(state.user.lastPracticeDate).toDateString() : null;
            
            if (lastDate === today) return;
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();
            
            if (lastDate === yesterdayStr) {
                state.user.consecutiveDays++;
                if (state.user.consecutiveDays % 3 === 0) {
                    state.user.comboMultiplier = Math.min(3, Math.floor(state.user.consecutiveDays / 3));
                    showAchievement(`üî• ${state.user.consecutiveDays}-Day Combo! ${state.user.comboMultiplier}x Coins!`);
                }
            } else if (lastDate && lastDate !== today) {
                state.user.consecutiveDays = 1;
                state.user.comboMultiplier = 1;
            }
            
            state.user.lastPracticeDate = new Date().toISOString();
            saveState();
        }

        function checkDailyCheckin() {
            const today = new Date().toDateString();
            if (dailyCheckin.lastCheckin !== today) {
                earnCoins(50 * state.user.comboMultiplier);
                dailyCheckin.streak++;
                dailyCheckin.lastCheckin = today;
                showPurchaseModal('Daily Check-in!', `üéØ +${50 * state.user.comboMultiplier} coins! Streak: ${dailyCheckin.streak} days`);
                saveState();
                return true;
            }
            return false;
        }

        // ====== ACHIEVEMENT SYSTEM ======
        function checkAchievements() {
            const completedCount = state.completedSkills.length;
            
            if (completedCount >= 1 && !achievements.firstBadge) {
                achievements.firstBadge = true;
                showAchievement('üèÜ First Badge Unlocked!');
            }
            
            if (completedCount >= 5 && !achievements.fiveSkills) {
                achievements.fiveSkills = true;
                earnCoins(500);
                showAchievement('üåü 5 Skills Mastered! +500 coins!');
            }
            
            if (dailyCheckin.streak >= 10 && !achievements.tenDays) {
                achievements.tenDays = true;
                earnCoins(1000);
                showAchievement('üî• 10-Day Streak! +1000 coins!');
            }
            
            saveState();
        }

        function showAchievement(message) {
            triggerAchievementConfetti();
            setTimeout(() => {
                showPurchaseModal('Achievement Unlocked!', message);
            }, 500);
        }

        // ====== TEMPLATE FUNCTION ======
        function createNewSkill(spec) {
            return {
                id: spec.id,
                name: spec.name,
                icon: spec.icon,
                color: spec.color,
                tagline: spec.tagline,
                simpleExplain: spec.simpleExplain,
                prerequisite: spec.prerequisite || null,
                
                // NEW: Hook‚ÜíExperience‚ÜíInsight‚ÜíPractice‚ÜíIntegration flow
                newSteps: ['hook', 'experience', 'reveal', 'contrast', 'practice', 'integration', 'victory'],
                
                // Step 1: HOOK (30 seconds)
                hook: {
                    title: spec.hook.title,
                    visual: spec.hook.visual || getDefaultVisual(spec.id),
                    copy: spec.hook.copy,
                    cta: spec.hook.cta || 'Try This Challenge ‚Üí'
                },
                
                // Step 2: EXPERIENCE (90 seconds)
                experience: {
                    title: spec.experience.title,
                    instructions: spec.experience.instructions,
                    timer: spec.experience.timer || getDefaultTimer(spec.id),
                    checkboxes: spec.experience.checkboxes || [],
                    reflectionPrompt: spec.experience.reflectionPrompt,
                    requiresButton: spec.id === 'checkin'
                },
                
                // Step 3: THE REVEAL (90 seconds)
                reveal: {
                    title: spec.reveal.title,
                    visual: spec.reveal.visual || getRevealVisual(spec.id),
                    copy: spec.reveal.copy
                },
                
                // Step 4: THE CONTRAST (2 minutes)
                contrast: {
                    title: spec.contrast.title,
                    modeA: {
                        title: spec.contrast.modeA.title,
                        steps: spec.contrast.modeA.steps,
                        feeling: spec.contrast.modeA.feeling
                    },
                    modeB: {
                        title: spec.contrast.modeB.title,
                        steps: spec.contrast.modeB.steps,
                        feeling: spec.contrast.modeB.feeling
                    }
                },
                
                // Step 5: PRACTICE NOW (2 minutes)
                practice: {
                    title: spec.practice.title,
                    instructions: spec.practice.instructions,
                    timer: spec.practice.timer || 60,
                    prompts: spec.practice.prompts || [],
                    ratingPrompt: spec.practice.ratingPrompt,
                    wordPrompt: spec.practice.wordPrompt,
                    requiresGoalSelection: spec.id === 'effectively'
                },
                
                // Step 6: INTEGRATION (90 seconds)
                integration: {
                    title: spec.integration.title,
                    mission: spec.integration.mission,
                    examples: spec.integration.examples,
                    explanation: spec.integration.explanation,
                    trackerGoal: spec.integration.trackerGoal || 5,
                    trackerBonus: spec.integration.trackerBonus || 5
                },
                
                // Step 7: VICTORY
                victory: {
                    title: `Skill Unlocked! ${spec.victory.badge.emoji}`,
                    badge: spec.victory.badge,
                    learnings: spec.victory.learnings,
                    quote: spec.victory.quote
                }
            };
        }

        // Helper functions for visuals and timers
        function getDefaultVisual(skillId) {
            const visuals = {
                'observe': 'üåÄ',
                'describe': 'üé≠',
                'participate': 'üëª',
                'nonjudgment': '‚öñÔ∏è',
                'onemindfully': 'üåÄ',
                'effectively': 'üëë',
                'checkin': 'ü§ñ'
            };
            return visuals[skillId] || 'üåÄ';
        }

        function getRevealVisual(skillId) {
            const visuals = {
                'observe': 'üß†',
                'describe': 'üì∞',
                'participate': 'üéÆ',
                'nonjudgment': 'üî¨',
                'onemindfully': 'üç≥',
                'effectively': '‚ôüÔ∏è',
                'checkin': 'üöó'
            };
            return visuals[skillId] || 'üí°';
        }

        function getDefaultTimer(skillId) {
            const timers = {
                'observe': 30,
                'describe': 0,
                'participate': 60,
                'nonjudgment': 0,
                'onemindfully': 60,
                'effectively': 0,
                'checkin': 0
            };
            return timers[skillId] || 30;
        }

        // ====== SKILL SPECIFICATIONS ======
        
        // SKILL 1: OBSERVE
        const observeSpec = {
            id: 'observe',
            name: 'OBSERVE',
            icon: 'üëÅÔ∏è',
            color: 'from-purple-600 to-pink-600',
            tagline: 'Watch thoughts like clouds drifting by',
            simpleExplain: 'Notice thoughts, feelings, and sensations without trying to change or fight them',
            prerequisite: null,
            
            hook: {
                title: 'The Thought Trap Experiment',
                copy: `Right now, you're thinking. But can you stop thinking? Not "think less" or "think calmer" ‚Äî completely STOP. Let's test it.`,
                cta: 'Try the 30-Second Challenge ‚Üí'
            },
            
            experience: {
                title: 'The Impossible Challenge',
                instructions: [
                    'Close your eyes',
                    'For 30 seconds, force your mind to go completely blank',
                    'Fight every thought that appears',
                    'Push them away with mental effort',
                    'Ready? Timer starts now...'
                ],
                checkboxes: [
                    'Thoughts multiplied',
                    'Got frustrated',
                    'Thoughts got louder',
                    'Felt like failing'
                ],
                reflectionPrompt: 'In one sentence: What did fighting your thoughts feel like?'
            },
            
            reveal: {
                title: "The Brain's Secret",
                copy: `You didn't fail. The challenge was impossible.
Your brain produces 6,000 thoughts per day ‚Äî automatically.
Trying to stop thoughts is like trying to stop your heart from beating.
The harder you fight ‚Üí The stronger thoughts become
This is called the "White Bear Effect" ‚Äî try NOT to think of a white bear right now. See?
The Analogy:
üé¨ Your Mind = A Movie Theater
Bad strategy: Jump on screen and wrestle the characters
Smart strategy: Sit back and watch the show
Thoughts aren't the enemy. Fighting them is.`
            },
            
            contrast: {
                title: 'Two Ways to Handle Thoughts',
                modeA: {
                    title: '‚ùå FIGHTER MODE',
                    steps: [
                        'Anxious thought appears',
                        '"Stop thinking that!"',
                        'Try to suppress it',
                        'Thought gets stronger',
                        'Fight harder',
                        'Exhaustion + overwhelm'
                    ],
                    feeling: 'üò´ Drowning in quicksand'
                },
                modeB: {
                    title: '‚úÖ OBSERVER MODE',
                    steps: [
                        'Anxious thought appears',
                        '"Hmm, there\'s anxiety"',
                        'Watch it like a cloud',
                        'It drifts and fades',
                        'Return to now',
                        'Calm + spacious'
                    ],
                    feeling: 'üòå Floating on water'
                }
            },
            
            practice: {
                title: 'Your Turn: 60-Second Observer',
                instructions: `This time, don't fight anything. Just notice thoughts like:
‚Ä¢ "Planning thought"
‚Ä¢ "Worry thought"
‚Ä¢ "Memory thought"
Label and let drift.`,
                prompts: [
                    'Notice what\'s here...',
                    'Just watching, not fixing...',
                    'Thoughts come and go...',
                    'You\'re the sky, not the clouds...'
                ],
                ratingPrompt: 'Rate how this felt:',
                wordPrompt: 'One word to describe it:'
            },
            
            integration: {
                title: 'Use It Today',
                mission: 'üìã Every time you notice an emotion today, whisper: "Noticing [emotion]"',
                examples: [
                    'Feel irritated ‚Üí "Noticing irritation"',
                    'Feel anxious ‚Üí "Noticing anxiety"',
                    'Feel happy ‚Üí "Noticing joy"'
                ],
                explanation: `The word "noticing" creates instant distance.
You shift from inside the emotion to observing it.
It's like pressing pause.`,
                trackerGoal: 5,
                trackerBonus: 5
            },
            
            victory: {
                badge: {
                    emoji: 'üëÅÔ∏è',
                    name: 'Observer Badge',
                    color: 'purple'
                },
                learnings: [
                    '‚úì Fighting thoughts makes them stronger',
                    '‚úì Observing creates space and calm',
                    '‚úì You are the sky, not the clouds',
                    '‚úì "Noticing" is your new superpower'
                ],
                quote: '"I don\'t need to control my thoughts. I just need to watch them pass."'
            }
        };

        // SKILL 2: DESCRIBE
        const describeSpec = {
            id: 'describe',
            name: 'DESCRIBE',
            icon: 'üìù',
            color: 'from-blue-600 to-cyan-600',
            tagline: 'Stick to facts ‚Äî drop the drama',
            simpleExplain: 'Report only what actually happened, without adding judgmental or exaggerated stories',
            prerequisite: 'observe',
            
            hook: {
                title: 'The Drama Multiplier',
                copy: `A friend doesn't text back. Your brain doesn't say: "No response yet." It says: "They hate me. I'm always ignored. This is unbearable." Notice the drama? Let's see how much your brain adds...`,
                cta: 'See Your Drama Level ‚Üí'
            },
            
            experience: {
                title: 'Catch Your Brain Exaggerating',
                instructions: [
                    'Think of something mildly annoying that happened recently',
                    'Now let your brain go full drama mode',
                    'Use dramatic words like "always," "never," "catastrophe"',
                    'Really lean into how awful it was'
                ],
                checkboxes: [
                    'Always / Never',
                    'Catastrophe / Disaster',
                    'Totally / Completely',
                    'Should have / Ruined',
                    'Impossible / Unbearable'
                ],
                reflectionPrompt: 'Write the full dramatic version (go wild):'
            },
            
            reveal: {
                title: 'Your Brain Adds Suffering',
                copy: `Event: What actually happened
Story: What your brain added

The event caused pain.
The story multiplied it by 10.

The Science:
Your brain evolved to spot threats.
It labels everything as "good/bad," "fair/unfair."
These labels aren't facts ‚Äî they're opinions.
And opinions create suffering.

The Analogy:
üì∞ News Reporter vs. Soap Opera
Reporter: "It rained today."
Soap opera: "The SKY OPENED and DESTROYED everything!"

Same event. Different suffering.`
            },
            
            contrast: {
                title: 'Two Ways to Describe',
                modeA: {
                    title: '‚ùå DRAMA MODE',
                    steps: [
                        'Friend doesn\'t reply',
                        '"They HATE me"',
                        '"I\'m ALWAYS ignored"',
                        '"This is UNBEARABLE"',
                        'Spiral into despair'
                    ],
                    feeling: 'üò∞ Crushing weight'
                },
                modeB: {
                    title: '‚úÖ REPORTER MODE',
                    steps: [
                        'Friend doesn\'t reply',
                        '"No response yet"',
                        '"They might be busy"',
                        '[Just the facts]',
                        'Stay grounded'
                    ],
                    feeling: 'üòå Manageable calm'
                }
            },
            
            practice: {
                title: 'Strip Away the Drama',
                instructions: `Take that same situation. Rewrite it using ONLY observable facts:
‚Ä¢ No "always/never"
‚Ä¢ No "should/shouldn't"
‚Ä¢ No judgments
‚Ä¢ No mind-reading

Just the facts.`,
                ratingPrompt: 'How much lighter does the facts version feel?',
                wordPrompt: 'One word for the difference:'
            },
            
            integration: {
                title: 'Your Drama Detector',
                mission: 'üéØ Catch yourself using drama words, then replace with neutral facts.',
                examples: [
                    '‚ùå "I always mess up" ‚Üí ‚úÖ "I made a mistake this time"',
                    '‚ùå "This meeting is unbearable" ‚Üí ‚úÖ "This meeting is lasting 45 minutes"',
                    '‚ùå "They should text back" ‚Üí ‚úÖ "They haven\'t texted yet"'
                ],
                explanation: `Drama words multiply suffering. Neutral facts keep you grounded. Catch the drama, state the facts, feel the relief.`,
                trackerGoal: 3,
                trackerBonus: 10
            },
            
            victory: {
                badge: {
                    emoji: 'üì∞',
                    name: 'Clear Reporter',
                    color: 'blue'
                },
                learnings: [
                    '‚úì Your brain adds dramatic stories',
                    '‚úì Stories multiply suffering',
                    '‚úì Facts keep you grounded',
                    '‚úì "Just the facts" is your new filter'
                ],
                quote: '"Facts are friendly. Drama is optional."'
            }
        };

        // SKILL 3: PARTICIPATE
        const participateSpec = {
            id: 'participate',
            name: 'PARTICIPATE',
            icon: 'üåø',
            color: 'from-green-600 to-emerald-600',
            tagline: 'Be fully where your feet are',
            simpleExplain: 'Bring your full attention to whatever you\'re doing right now',
            prerequisite: 'observe',
            
            hook: {
                title: 'The Ghost Life Test',
                copy: `Right now, are you actually here? Or is your mind replaying yesterday‚Ä¶ planning tomorrow‚Ä¶ worrying about later? Most people are physically present but mentally absent 90% of the time. Let's test how present you really are.`,
                cta: 'Test Your Presence ‚Üí'
            },
            
            experience: {
                title: 'The Invisible Walk',
                instructions: [
                    'Stand up (really, do it)',
                    'Walk slowly across the room',
                    'Let your mind wander completely',
                    'Think about your to-do list, worries, plans',
                    'Don\'t try to feel your feet at all',
                    'Walk for 60 seconds...'
                ],
                checkboxes: [
                    'Temperature of the air',
                    'Pressure in your feet',
                    'Your breathing',
                    'Sounds around you',
                    'The feeling of movement'
                ],
                reflectionPrompt: 'How many sensations did you miss?'
            },
            
            reveal: {
                title: 'You Were a Ghost',
                copy: `Your body was moving. Your mind was elsewhere.
You were physically here but experientially gone.
This is how most people live ‚Äî on autopilot.

The Cost:
Life becomes a blur.
Memories are vague.
Joy feels muted.
Time vanishes.

You're alive, but not truly LIVING.

The Analogy:
üéÆ Playing a Game While Scrolling Your Phone
The game's beautiful graphics? Missed.
The epic moments? Missed.
The entire experience? Missed.

That's what happens when your mind isn't present.`
            },
            
            contrast: {
                title: 'Two Ways to Experience',
                modeA: {
                    title: '‚ùå GHOST MODE',
                    steps: [
                        'Eating lunch',
                        'Mind on work stress',
                        'Don\'t taste food',
                        'Meal ends (when??)',
                        'Feel unsatisfied'
                    ],
                    feeling: 'üò∂‚Äçüå´Ô∏è Numb blur'
                },
                modeB: {
                    title: '‚úÖ FULLY ALIVE MODE',
                    steps: [
                        'Eating lunch',
                        'Notice smell, texture, flavor',
                        'Chew slowly',
                        'Experience each bite',
                        'Feel nourished + satisfied'
                    ],
                    feeling: '‚ú® Vivid + rich'
                }
            },
            
            practice: {
                title: 'The Present Walk',
                instructions: `Walk again. Same path. This time, notice everything:
‚Ä¢ Feel your feet touching the ground
‚Ä¢ Notice the temperature on your skin
‚Ä¢ Hear the sounds around you
‚Ä¢ Feel your breath moving`,
                ratingPrompt: 'How alive and vivid did this walk feel?',
                wordPrompt: 'One word for the difference:'
            },
            
            integration: {
                title: 'One Meal, Fully Present',
                mission: 'üçΩÔ∏è Eat ONE meal today with ZERO distractions',
                examples: [
                    'No phone, no TV, no reading',
                    'Just: smell, taste, texture, chew',
                    'Notice when mind wanders, gently return'
                ],
                explanation: `Presence turns ordinary moments into extraordinary experiences. One fully present meal teaches more than hours of distracted living.`,
                trackerGoal: 1,
                trackerBonus: 20
            },
            
            victory: {
                badge: {
                    emoji: 'üåø',
                    name: 'Fully Present',
                    color: 'green'
                },
                learnings: [
                    '‚úì Most of life is lived on autopilot',
                    '‚úì Presence makes everything vivid',
                    '‚úì Your senses are a doorway to NOW',
                    '‚úì One fully present moment > hours of distraction'
                ],
                quote: '"Wherever you are, be all there."'
            }
        };

        // SKILL 4: NONJUDGMENTALLY
        const nonjudgmentSpec = {
            id: 'nonjudgment',
            name: 'NONJUDGMENTALLY',
            icon: '‚öñÔ∏è',
            color: 'from-orange-600 to-red-600',
            tagline: 'Just notice ‚Äî no "good" or "bad" needed',
            simpleExplain: 'Observe experiences exactly as they are, without adding labels or self-criticism',
            prerequisite: 'describe',
            
            hook: {
                title: 'The Second Arrow',
                copy: `You make a mistake. That's Arrow #1 (the event). Then your brain shoots Arrow #2: "I'm so stupid. I always fail. I'm worthless." Arrow #1 hurts. Arrow #2 is self-inflicted torture. Let's see how many arrows you shoot at yourself...`,
                cta: 'Count Your Arrows ‚Üí'
            },
            
            experience: {
                title: 'Aim All Arrows at Yourself',
                instructions: [
                    'Think of a recent mistake or flaw',
                    'Now be as harsh as possible',
                    'Use the cruelest words you can',
                    'Really attack yourself for 30 seconds'
                ],
                checkboxes: [
                    'Stupid / Failure',
                    'Pathetic / Worthless',
                    'Loser / Broken',
                    'Unlovable / Disaster',
                    'Should be better'
                ],
                reflectionPrompt: 'Write the full self-attack:'
            },
            
            reveal: {
                title: 'You\'re Shooting Yourself',
                copy: `The mistake = Arrow #1 (you couldn't control)
The judgment = Arrow #2 (you chose to shoot)

Arrow #2 doesn't fix Arrow #1.
It just adds more pain.

The Science:
Self-judgment activates the same brain regions as physical pain.
It triggers:
‚Ä¢ Stress hormones
‚Ä¢ Inflammation
‚Ä¢ Shutdown mode

You can't learn when you're in pain.

The Analogy:
üî¨ Scientist vs. Cruel Judge
Scientist: "Experiment failed. Interesting. What went wrong?"
Judge: "YOU failed. You're a failure. Give up."

Which one makes progress?`
            },
            
            contrast: {
                title: 'Two Ways to Respond',
                modeA: {
                    title: '‚ùå JUDGE MODE',
                    steps: [
                        'Make mistake',
                        '"I\'m so stupid!"',
                        'Shame spiral begins',
                        'Feel worthless',
                        'Can\'t think clearly',
                        'Stuck + hopeless'
                    ],
                    feeling: 'üòû Crushed by shame'
                },
                modeB: {
                    title: '‚úÖ SCIENTIST MODE',
                    steps: [
                        'Make mistake',
                        '"This didn\'t work"',
                        '"What can I learn?"',
                        'Stay curious',
                        'Mind stays clear',
                        'Growth possible'
                    ],
                    feeling: 'üåü Open + curious'
                }
            },
            
            practice: {
                title: 'Remove the Arrows',
                instructions: `Same situation. No judgment this time.
Rewrite using ONLY:
‚Ä¢ Neutral observations
‚Ä¢ What happened (facts)
‚Ä¢ What you could learn`,
                ratingPrompt: 'How much lighter does the scientist version feel?',
                wordPrompt: 'How does dropping judgment feel?'
            },
            
            integration: {
                title: 'Catch the Judge',
                mission: 'üéØ Every time you catch self-judgment: 1. Say "Judging" 2. State ONE neutral fact 3. Move on',
                examples: [
                    '‚ùå "I\'m so lazy" ‚Üí "Judging" ‚Üí ‚úÖ "I haven\'t started that task yet"',
                    '‚ùå "This is terrible" ‚Üí "Judging" ‚Üí ‚úÖ "This is challenging"',
                    '‚ùå "I\'m a bad person" ‚Üí "Judging" ‚Üí ‚úÖ "I made a choice I regret"'
                ],
                explanation: `Judgment = self-inflicted pain. Facts create space to learn. Catch the judge, state facts, stay curious.`,
                trackerGoal: 5,
                trackerBonus: 5
            },
            
            victory: {
                badge: {
                    emoji: 'üî¨',
                    name: 'Nonjudging Mind',
                    color: 'orange'
                },
                learnings: [
                    '‚úì Judgment = self-inflicted pain',
                    '‚úì Facts create space to learn',
                    '‚úì Curiosity > Criticism',
                    '‚úì You can observe without attacking'
                ],
                quote: '"The curious mind grows. The judging mind suffers."'
            }
        };

        // SKILL 5: ONE-MINDFULLY
        const oneMindfullySpec = {
            id: 'onemindfully',
            name: 'ONE-MINDFULLY',
            icon: 'üéØ',
            color: 'from-indigo-600 to-purple-600',
            tagline: 'One thing, fully and completely',
            simpleExplain: 'Give your full attention to one activity at a time',
            prerequisite: 'participate',
            
            hook: {
                title: 'The Multitasking Myth',
                copy: `Your brain tells you: "I can do 5 things at once!" Science says: You can't. Every time you "multitask," your brain is actually rapidly switching ‚Äî and losing time with each switch. Up to 40% of your focus evaporates. Let's prove it.`,
                cta: 'Test Your Focus ‚Üí'
            },
            
            experience: {
                title: 'The Impossible Juggle',
                instructions: [
                    'Do all three tasks at the same time:',
                    'Task 1: Count backwards from 100 by 7s',
                    'Task 2: Name 5 items in your fridge',
                    'Task 3: Plan tonight\'s dinner',
                    'Keep all three tasks going for 60 seconds!'
                ],
                timer: 60,
                checkboxes: [
                    'Frazzled / Exhausted',
                    'Overwhelmed / Scattered',
                    'Frustrated / Ineffective',
                    'Made many errors',
                    'Lost track completely'
                ],
                reflectionPrompt: 'How well did you perform any of the tasks?'
            },
            
            reveal: {
                title: 'Your Brain Can\'t Multitask',
                copy: `What you just felt = your brain context-switching.
Each switch costs:
‚Ä¢ Time (up to 40% lost)
‚Ä¢ Energy (mental fatigue)
‚Ä¢ Quality (more errors)
‚Ä¢ Memory (poor retention)

The Science:
Brain imaging shows multitasking shrinks your prefrontal cortex over time.
Masters in any field (athletes, artists, surgeons) all do the same thing:
One thing, fully.

The Analogy:
üç≥ Master Chef vs. Frantic Cook
Master: Focuses on one perfect dish
Frantic: Burns everything while juggling five pans
Excellence requires singular focus.`
            },
            
            contrast: {
                title: 'Two Ways to Work',
                modeA: {
                    title: '‚ùå SCATTERED MODE',
                    steps: [
                        'Working on report',
                        'Check phone',
                        'Think about email',
                        'Start different task',
                        'Brain ping-pongs',
                        'Exhausted, nothing done'
                    ],
                    feeling: 'üòµ‚Äçüí´ Chaos'
                },
                modeB: {
                    title: '‚úÖ LASER MODE',
                    steps: [
                        'Working on report',
                        'Close all distractions',
                        'Full attention here',
                        'Work with flow',
                        'Brain calm + clear',
                        'Task completed well'
                    ],
                    feeling: 'üéØ Flow state'
                }
            },
            
            practice: {
                title: 'One Task, Full Focus',
                instructions: `Pick ONE simple task:
‚Ä¢ Write 3 sentences
‚Ä¢ Organize one drawer
‚Ä¢ Reply to one message

Do ONLY this for 2 minutes.
No phone. No other tabs. No planning.`,
                prompts: [
                    'Stay with this one thing...',
                    'When mind wanders, gently return...',
                    'Just this, nothing else...'
                ],
                ratingPrompt: 'How satisfying was completion?',
                wordPrompt: 'One word for this focused state:'
            },
            
            integration: {
                title: 'One Meal, Zero Screens',
                mission: 'üçΩÔ∏è Eat ONE full meal with ZERO distractions',
                examples: [
                    'Remove: Phone, TV/laptop, Books/reading',
                    'Just: Food, Your senses, This moment',
                    'Notice: Taste, texture, smell, chewing'
                ],
                explanation: `Multitasking steals 40% of focus. One-mindfully returns it. One fully focused meal teaches your brain what single-tasking feels like.`,
                trackerGoal: 1,
                trackerBonus: 25
            },
            
            victory: {
                badge: {
                    emoji: 'üéØ',
                    name: 'Laser Focus',
                    color: 'indigo'
                },
                learnings: [
                    '‚úì Multitasking is a myth',
                    '‚úì Context-switching steals 40% of focus',
                    '‚úì One thing fully > many things poorly',
                    '‚úì Masters do one thing at a time'
                ],
                quote: '"The person who chases two rabbits catches neither."'
            }
        };

        // SKILL 6: EFFECTIVELY
        const effectivelySpec = {
            id: 'effectively',
            name: 'EFFECTIVELY',
            icon: '‚úÖ',
            color: 'from-pink-600 to-rose-600',
            tagline: 'Do what works ‚Äî not what feels "right"',
            simpleExplain: 'Choose actions that achieve your real goal, even if ego doesn\'t like it',
            prerequisite: 'nonjudgment',
            
            hook: {
                title: 'The Ego Trap',
                copy: `You're in an argument. You can either: A) Win the argument, damage the relationship B) Let it go, keep the peace. Your ego screams: "WIN! BE RIGHT!" But does "being right" actually get you what you want? Let's find out.`,
                cta: 'Discover What Works ‚Üí'
            },
            
            experience: {
                title: 'Feel the Need to Win',
                instructions: [
                    'Think of a recent disagreement',
                    'Feel the pull to prove you were right',
                    'Notice the urge to defend, prove, win',
                    'Lean into that ego-driven desire'
                ],
                checkboxes: [
                    'Defend your position',
                    'Prove they were wrong',
                    'Make them admit it',
                    'Win the argument',
                    'Show you\'re smarter',
                    'Get the last word',
                    'Make them see your side'
                ],
                reflectionPrompt: 'Did "being right" actually help?'
            },
            
            reveal: {
                title: 'Winning vs. Working',
                copy: `Your ego wants: To be right, to win, to look good
Your actual goal: Connection, solution, peace

These are often opposites.
"Being right" feels good for 5 seconds.
Effectiveness feels good for a lifetime.

The Principle:
Do what WORKS, not what your ego demands.

The Analogy:
‚ôüÔ∏è Chess Master
Amateur: Argues about the rules mid-game (and loses)
Master: Plays the best move to WIN THE GAME

The goal isn't being right.
The goal is the goal.`
            },
            
            contrast: {
                title: 'Two Ways to Respond',
                modeA: {
                    title: '‚ùå EGO MODE',
                    steps: [
                        'Disagreement happens',
                        'MUST prove I\'m right',
                        'Escalate to win',
                        'Other person hurt/angry',
                        '"Won" but relationship damaged',
                        'Feel empty'
                    ],
                    feeling: 'üò§ Hollow victory'
                },
                modeB: {
                    title: '‚úÖ STRATEGY MODE',
                    steps: [
                        'Disagreement happens',
                        'Ask: "What\'s my real goal here?"',
                        'Choose effectiveness',
                        'Let ego go',
                        'Achieve actual goal',
                        'Feel genuinely satisfied'
                    ],
                    feeling: 'üòä True success'
                }
            },
            
            practice: {
                title: 'Name Your Real Goal',
                instructions: `Same disagreement. Forget "being right."
What did you ACTUALLY want?

Common real goals:
‚Ä¢ To feel heard
‚Ä¢ To stay connected
‚Ä¢ To solve the problem
‚Ä¢ To preserve peace
‚Ä¢ To be understood
‚Ä¢ To move forward together`,
                ratingPrompt: 'Which serves your actual goal better?',
                wordPrompt: 'My real goal was:'
            },
            
            integration: {
                title: 'Ask Before Reacting',
                mission: 'üéØ Next time you feel defensive/reactive: Pause and ask: "What do I actually want here?" Then choose the action that gets you THERE.',
                examples: [
                    'Ego says: "Prove I\'m right!" ‚Üí Real goal: Stay connected ‚Üí Effective action: Listen first',
                    'Ego says: "Win this argument!" ‚Üí Real goal: Solve the problem ‚Üí Effective action: Find compromise',
                    'Ego says: "Defend myself!" ‚Üí Real goal: Peace ‚Üí Effective action: Let it go'
                ],
                explanation: `Ego ‚â† Effectiveness. "Being right" often costs you what you want. Effectiveness gets you what matters. Pause, ask, choose wisely.`,
                trackerGoal: 2,
                trackerBonus: 15
            },
            
            victory: {
                badge: {
                    emoji: '‚ôüÔ∏è',
                    name: 'Wise Strategist',
                    color: 'pink'
                },
                learnings: [
                    '‚úì Ego ‚â† Effectiveness',
                    '‚úì "Being right" often costs you what you want',
                    '‚úì Real goals > feeling superior',
                    '‚úì Masters ask: "What will actually work?"'
                ],
                quote: '"Would you rather be right, or would you rather be happy?"'
            }
        };

        // SKILL 7: CHECK THE FACTS
        const checkFactsSpec = {
            id: 'checkin',
            name: 'CHECK-IN',
            icon: 'üß†',
            color: 'from-teal-600 to-cyan-600',
            tagline: 'Know your inner state before acting',
            simpleExplain: 'Pause briefly to scan mood, body, and energy before responding',
            prerequisite: 'onemindfully',
            
            hook: {
                title: 'Autopilot Reactions',
                copy: `Someone asks: "How are you?" You instantly say: "I'm fine." But are you actually fine? Or did you just‚Ä¶ autopilot? Most people react to life without checking what's TRUE inside. Let's test your autopilot.`,
                cta: 'Test Your Awareness ‚Üí'
            },
            
            experience: {
                title: 'The Auto-Response',
                instructions: [
                    'Don\'t think. Just REACT.',
                    'How are you right now?',
                    'Click the button without checking',
                    'Give your automatic answer'
                ],
                checkboxes: [
                    'Yes, I checked',
                    'No, I just auto-answered',
                    'Honestly not sure',
                    'Said what I always say',
                    'Didn\'t actually know'
                ],
                reflectionPrompt: 'Was that actually accurate?'
            },
            
            reveal: {
                title: 'You\'re on Autopilot',
                copy: `Your brain runs on autopilot 95% of the time.
It reacts based on:
‚Ä¢ Old patterns
‚Ä¢ Assumptions
‚Ä¢ Habitual responses
Not based on current reality.

This causes you to:
‚Ä¢ Miss warning signs
‚Ä¢ React inappropriately
‚Ä¢ Make choices you regret
‚Ä¢ Feel out of control

The Fix:
Check the Facts = Glance at your internal dashboard

Before reacting, take 10 seconds to scan:
‚Ä¢ Mood
‚Ä¢ Body
‚Ä¢ Energy
‚Ä¢ Urges

The Analogy:
üöó Driving Without Looking at Dashboard
You wouldn't know:
‚Ä¢ If fuel is low
‚Ä¢ If engine is overheating
‚Ä¢ If tire pressure is critical

Check-the-Facts = looking at your internal gauges`
            },
            
            contrast: {
                title: 'Two Ways to Respond',
                modeA: {
                    title: '‚ùå AUTOPILOT MODE',
                    steps: [
                        'Trigger happens',
                        'React instantly from habit',
                        'Miss internal warning signs',
                        'Words/actions you regret',
                        'Feel out of control'
                    ],
                    feeling: 'ü§ñ Reactive robot'
                },
                modeB: {
                    title: '‚úÖ CHECK-IN MODE',
                    steps: [
                        'Trigger happens',
                        'Pause 10 seconds',
                        'Scan: mood, body, energy',
                        'Respond intentionally',
                        'Feel in control'
                    ],
                    feeling: 'üß≠ Wise navigator'
                }
            },
            
            practice: {
                title: '10-Second Check-In',
                instructions: `Right now, actually CHECK:

MOOD: How do you feel emotionally?
BODY: Where do you feel tension?
ENERGY: High or low?
URGES: What do you feel pulled to do?

Take 10 seconds. Really check.`,
                ratingPrompt: 'How intense is your mood right now?',
                wordPrompt: 'One-word mood label:'
            },
            
            integration: {
                title: '3 Check-Ins Today',
                mission: 'üß≠ Before responding to anything emotional: 10-second scan: 1. Mood (name it) 2. Body (where\'s tension?) 3. Energy (high or low?) Then choose your response.',
                examples: [
                    'Before replying to a text',
                    'Before speaking when upset',
                    'Before making a decision',
                    'When someone asks how you are',
                    'When feeling triggered'
                ],
                explanation: `Most reactions are autopilot. 10-second check-in restores control. Checking facts ‚â† checking assumptions. Awareness creates choice.`,
                trackerGoal: 3,
                trackerBonus: 10
            },
            
            victory: {
                badge: {
                    emoji: 'üß≠',
                    name: 'Inner Compass',
                    color: 'teal'
                },
                learnings: [
                    '‚úì Most reactions are autopilot',
                    '‚úì 10-second check-in restores control',
                    '‚úì Checking facts ‚â† checking assumptions',
                    '‚úì Awareness creates choice'
                ],
                quote: '"Between stimulus and response there is a space. In that space is our power to choose."'
            }
        };

        // ====== CREATE ALL SKILLS USING TEMPLATE ======
        const newObserveSkill = createNewSkill(observeSpec);
        const newDescribeSkill = createNewSkill(describeSpec);
        const newParticipateSkill = createNewSkill(participateSpec);
        const newNonjudgmentSkill = createNewSkill(nonjudgmentSpec);
        const newOneMindfullySkill = createNewSkill(oneMindfullySpec);
        const newEffectivelySkill = createNewSkill(effectivelySpec);
        const newCheckFactsSkill = createNewSkill(checkFactsSpec);

        // ====== SKILLS ARRAY WITH ALL 7 SKILLS ======
        const skills = [
            newObserveSkill,
            newDescribeSkill,
            newParticipateSkill,
            newNonjudgmentSkill,
            newOneMindfullySkill,
            newEffectivelySkill,
            newCheckFactsSkill
        ];

        // ====== SHOP ITEMS ======
        const shopItems = [
            { id: 'theme_ocean', name: 'üåä Ocean Calm', cost: 150, type: 'theme', value: 'ocean' },
            { id: 'theme_sunset', name: 'üåÖ Sunset Glow', cost: 150, type: 'theme', value: 'sunset' },
            { id: 'theme_forest', name: 'üå≤ Forest Peace', cost: 150, type: 'theme', value: 'forest' },
            { id: 'theme_midnight', name: 'üåô Midnight Depth', cost: 200, type: 'theme', value: 'midnight' },
            { id: 'theme_rose', name: 'üåπ Rose Warmth', cost: 200, type: 'theme', value: 'rose' },
            { id: 'avatar_zen', name: 'üßò Zen Master', cost: 75, type: 'avatar', value: 'üßò' },
            { id: 'avatar_star', name: '‚≠ê Shining Star', cost: 75, type: 'avatar', value: '‚≠ê' },
            { id: 'avatar_fire', name: 'üî• Inner Fire', cost: 100, type: 'avatar', value: 'üî•' },
            { id: 'avatar_brain', name: 'üß† Wise Mind', cost: 100, type: 'avatar', value: 'üß†' },
            { id: 'avatar_heart', name: 'üíñ Open Heart', cost: 100, type: 'avatar', value: 'üíñ' },
            { id: 'avatar_lightning', name: '‚ö° Clear Focus', cost: 125, type: 'avatar', value: '‚ö°' },
            { id: 'avatar_crown', name: 'üëë Mastery', cost: 150, type: 'avatar', value: 'üëë' }
        ];

        // ====== TIMER FUNCTIONS ======
        function startTimer(seconds) {
            clearInterval(timerInterval);
            let timeLeft = seconds;
            const display = document.getElementById('timerDisplay');
            const button = document.querySelector('#timerSection button');
            
            if (display && button) {
                button.disabled = true;
                button.textContent = 'Focus...';
                button.classList.remove('from-blue-600', 'to-cyan-600');
                button.classList.add('from-gray-400', 'to-gray-500');
                display.classList.add('timer-pulse');
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    display.textContent = timeLeft;
                    
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        display.classList.remove('timer-pulse');
                        document.getElementById('postTimerSection').classList.remove('hidden');
                        document.getElementById('timerSection').classList.add('hidden');
                        document.getElementById('postTimerSection').classList.add('fade-in');
                    }
                }, 1000);
            }
        }

        function startPracticeTimer(seconds) {
            clearInterval(practiceTimerInterval);
            practicePromptIndex = 0;
            let timeLeft = seconds;
            const display = document.getElementById('practiceTimerDisplay');
            const promptsDiv = document.getElementById('practicePrompts');
            const button = document.querySelector('#practiceTimerSection button');
            const prompts = state.activeSkill.practice.prompts || [];
            
            if (display && button && promptsDiv) {
                button.disabled = true;
                button.textContent = 'Focusing...';
                button.classList.remove('from-indigo-600', 'to-purple-600');
                button.classList.add('from-gray-400', 'to-gray-500');
                display.classList.add('timer-pulse');
                
                // Start with first prompt
                if (prompts.length > 0) {
                    promptsDiv.innerHTML = `<p class="text-purple-600 font-medium">${prompts[0]}</p>`;
                }
                
                practiceTimerInterval = setInterval(() => {
                    timeLeft--;
                    display.textContent = timeLeft;
                    
                    // Update prompt every 15 seconds
                    if (prompts.length > 0 && timeLeft % 15 === 0 && timeLeft < seconds - 1 && practicePromptIndex < prompts.length - 1) {
                        practicePromptIndex++;
                        promptsDiv.innerHTML = `<p class="text-purple-600 font-medium">${prompts[practicePromptIndex]}</p>`;
                    }
                    
                    if (timeLeft <= 0) {
                        clearInterval(practiceTimerInterval);
                        display.classList.remove('timer-pulse');
                        document.getElementById('postPracticeSection').classList.remove('hidden');
                        document.getElementById('practiceTimerSection').classList.add('hidden');
                        document.getElementById('postPracticeSection').classList.add('fade-in');
                        
                        // Restore button
                        button.disabled = false;
                        button.textContent = 'Start Practice';
                        button.classList.remove('from-gray-400', 'to-gray-500');
                        button.classList.add('from-indigo-600', 'to-purple-600');
                    }
                }, 1000);
            }
        }

        // ====== STEP COMPLETION FUNCTIONS ======
        function completeExperienceStep() {
            const skill = state.activeSkill;
            
            // Save checkbox data
            const checkboxes = skill.id === 'checkin' 
                ? document.querySelectorAll('#autoResponse input[type="checkbox"]')
                : document.querySelectorAll('#postTimerSection input[type="checkbox"]');
            
            const reflection = skill.id === 'checkin'
                ? document.getElementById('experienceReflection')
                : document.getElementById('experienceReflection');
            
            if (checkboxes.length > 0 && reflection) {
                const checkboxData = Array.from(checkboxes).map(cb => ({
                    label: cb.nextElementSibling?.textContent || '',
                    checked: cb.checked
                }));
                updateWorksheetData('exp_checkboxes', checkboxData);
                updateWorksheetData('exp_reflection', reflection.value);
            }
            
            completeNewStep();
        }

        function completePracticeStep() {
            const skill = state.activeSkill;
            
            if (skill.id === 'effectively') {
                // Save goal selection data
                const selectedGoal = document.querySelector('input[name="realGoal"]:checked');
                const effectiveAction = document.getElementById('effectiveAction');
                const realGoalInput = document.getElementById('realGoalInput');
                
                if (selectedGoal) updateWorksheetData('selected_goal', selectedGoal.value);
                if (effectiveAction) updateWorksheetData('effective_action', effectiveAction.value);
                if (realGoalInput) updateWorksheetData('real_goal', realGoalInput.value);
            } else {
                // Standard practice step handling
                const rating = document.getElementById('practiceRating');
                const word = document.getElementById('practiceWord');
                if (rating && word) {
                    updateWorksheetData('practice_rating', rating.value);
                    updateWorksheetData('practice_word', word.value);
                }
            }
            
            completeNewStep();
        }

        function completeNewStep() {
            const skill = state.activeSkill;
            if (!skill || !skill.newSteps) return;
            
            const steps = skill.newSteps;
            const currentIndex = steps.indexOf(state.currentStep);
            
            // Sync any unsaved data
            syncWorksheetData();
            
            // Award coins based on step
            const stepRewards = {
                hook: 10,
                experience: 15,
                reveal: 20,
                contrast: 25,
                practice: 40,
                integration: 100
            };
            
            if (stepRewards[state.currentStep]) {
                const reward = stepRewards[state.currentStep] * state.user.comboMultiplier;
                earnCoins(reward);
            }
            
            // Handle skill completion
            if (state.currentStep === 'integration' && !state.completedSkills.includes(skill.id)) {
                // Award badge and mark as completed
                updateState({
                    completedSkills: [...state.completedSkills, skill.id],
                    inventory: {
                        ...state.inventory,
                        badges: [...state.inventory.badges, skill.victory.badge]
                    },
                    user: {
                        ...state.user,
                        totalPractices: state.user.totalPractices + 1,
                        level: Math.floor((state.user.totalPractices + 1) / 3) + 1
                    }
                });
                
                // Save journal entry
                journalEntries.push({
                    skill: skill.name,
                    date: new Date().toISOString(),
                    responses: state.worksheetData
                });
                
                triggerConfetti();
                checkAchievements();
            }
            
            // Move to next step
            if (currentIndex < steps.length - 1) {
                updateState({ currentStep: steps[currentIndex + 1] });
                // Clear timers
                clearInterval(timerInterval);
                clearInterval(practiceTimerInterval);
                
                // Scroll to top
                setTimeout(() => window.scrollTo({ top: 0, behavior: 'smooth' }), 50);
            }
        }

        // ====== OPTIMIZED FUNCTIONS ======
        function updateState(newState) {
            state = { ...state, ...newState };
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => {
                render();
                saveState();
            }, 16);
        }

        function updateWorksheetData(key, value) {
            textareaCache[key] = value;
        }

        function syncWorksheetData() {
            if (Object.keys(textareaCache).length > 0) {
                updateState({ 
                    worksheetData: { ...state.worksheetData, ...textareaCache } 
                });
                textareaCache = {};
            }
        }

        function getWorksheetValue(key) {
            return textareaCache[key] || state.worksheetData[key] || '';
        }

        function earnCoins(amount) {
            const bonusAmount = amount * state.user.comboMultiplier;
            updateState({
                coinAmount: bonusAmount,
                showCoinAnimation: true,
                coins: state.coins + bonusAmount,
                user: { ...state.user, xp: state.user.xp + bonusAmount * 2 }
            });
            setTimeout(() => updateState({ showCoinAnimation: false }), 1500);
        }

        function showPurchaseModal(title, message) {
            document.getElementById('purchaseTitle').textContent = title;
            document.getElementById('purchaseMessage').textContent = message;
            document.getElementById('purchaseModal').classList.remove('hidden');
        }

        function closePurchaseModal() {
            document.getElementById('purchaseModal').classList.add('hidden');
        }

        function buyItem(item) {
            if (state.coins >= item.cost) {
                updateState({ 
                    coins: state.coins - item.cost,
                    lastPurchase: item,
                    purchaseHistory: [...state.purchaseHistory, {
                        ...item,
                        date: new Date().toISOString()
                    }]
                });
                
                if (item.type === 'theme') {
                    updateState({
                        inventory: { ...state.inventory, themes: [...state.inventory.themes, item.value] },
                        user: { ...state.user, theme: item.value }
                    });
                } else if (item.type === 'avatar') {
                    updateState({
                        inventory: { ...state.inventory, avatars: [...state.inventory.avatars, item.value] },
                        user: { ...state.user, avatar: item.value }
                    });
                }
                
                if (state.unreadShopItems > 0) {
                    updateState({ unreadShopItems: state.unreadShopItems - 1 });
                }
                
                showPurchaseModal('Purchase Successful!', `You bought ${item.name} for ${item.cost} coins. Enjoy your new item!`);
                return true;
            } else {
                const needed = item.cost - state.coins;
                showPurchaseModal('Not Enough Coins', `You need ${needed} more coins to purchase ${item.name}. Complete more mindfulness practices to earn coins!`);
                return false;
            }
        }

        function isOwned(item) {
            return item.type === 'theme' ? state.inventory.themes.includes(item.value) : state.inventory.avatars.includes(item.value);
        }

        // ====== UPDATED START SKILL FUNCTION ======
        function startSkill(id) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            const skill = skills.find(s => s.id === id);
            if (skill) {
                // Check if skill is locked
                if (skill.prerequisite && !state.completedSkills.includes(skill.prerequisite)) {
                    showPurchaseModal('Skill Locked', `Complete "${skills.find(s => s.id === skill.prerequisite)?.name}" first to unlock this skill!`);
                    return;
                }
                
                // Clear cache
                textareaCache = {};
                
                // Use new design for all skills
                updateState({
                    activeSkill: skill,
                    currentStep: 'hook', // Start with new step system
                    worksheetData: {},
                    screen: 'skill'
                });
            }
        }

        function handleShopItem(id) {
            const item = shopItems.find(i => i.id === id);
            if (item) {
                buyItem(item);
            }
        }

        function completeStep() {
            // This is for old skill system - not used anymore
            completeNewStep();
        }

        // ====== PRACTICE TRACKER FUNCTIONS ======
        function togglePracticeCheck(skillId, index) {
            if (!practiceTracker[skillId]) practiceTracker[skillId] = [];
            if (practiceTracker[skillId][index]) {
                practiceTracker[skillId][index] = false;
            } else {
                practiceTracker[skillId][index] = true;
                // Award small bonus for each practice
                earnCoins(5 * state.user.comboMultiplier);
            }
            saveState();
            render();
        }

        function getPracticeChecks(skillId) {
            return practiceTracker[skillId] || Array(12).fill(false);
        }

        function getRandomPractice() {
            if (state.completedSkills.length === 0) return null;
            const randomSkillId = state.completedSkills[Math.floor(Math.random() * state.completedSkills.length)];
            return skills.find(s => s.id === randomSkillId);
        }

        function shareProgress() {
            const progress = {
                skills: state.completedSkills.length,
                total: skills.length,
                level: state.user.level,
                streak: dailyCheckin.streak,
                coins: state.coins
            };
            
            const shareText = `üéØ I've mastered ${progress.skills}/7 mindfulness skills on MindPath! Level ${progress.level}, ${progress.streak}-day streak, ${progress.coins} coins earned. Try it yourself!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Mindfulness Progress',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText);
                showPurchaseModal('Copied to Clipboard!', 'Share your progress with friends!');
            }
        }

        function navigateTo(screen) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            updateState({ screen });
        }

        // ====== BOTTOM NAV RENDER ======
        function renderBottomNav() {
            const isSkill = state.screen === 'skill';
            return `
                <div class="bottom-nav fixed bottom-0 left-0 right-0 z-40">
                    <div class="max-w-md mx-auto flex items-center justify-around py-3">
                        <button onclick="navigateTo('home')" class="flex flex-col items-center gap-1 px-6 py-2 transition-smooth">
                            <div class="text-2xl">üè†</div>
                            <span class="text-xs font-medium ${state.screen === 'home' ? 'text-purple-600 font-bold' : 'text-gray-600'}">Home</span>
                        </button>
                        <button onclick="navigateTo('home')" class="flex flex-col items-center gap-1 px-6 py-2 transition-smooth">
                            <div class="text-2xl">${isSkill ? 'üéØ' : 'üß†'}</div>
                            <span class="text-xs font-bold text-purple-600">Skills</span>
                        </button>
                        <button onclick="navigateTo('shop')" class="flex flex-col items-center gap-1 px-6 py-2 relative transition-smooth">
                            ${state.unreadShopItems > 0 ? `<span class="nav-badge">${state.unreadShopItems}</span>` : ''}
                            <div class="text-2xl">üõçÔ∏è</div>
                            <span class="text-xs font-medium ${state.screen === 'shop' ? 'text-purple-600 font-bold' : 'text-gray-600'}">Shop</span>
                        </button>
                        <button onclick="navigateTo('profile')" class="flex flex-col items-center gap-1 px-6 py-2 relative transition-smooth">
                            ${state.inventory.badges.length > 0 ? `<span class="nav-badge">${state.inventory.badges.length}</span>` : ''}
                            <div class="text-2xl">üë§</div>
                            <span class="text-xs font-medium ${state.screen === 'profile' ? 'text-purple-600 font-bold' : 'text-gray-600'}">Profile</span>
                        </button>
                    </div>
                </div>
            `;
        }

        // ====== ENHANCED SKILL RENDER FUNCTION ======
        function renderNewSkillScreen() {
            const skill = state.activeSkill;
            const themeClass = `theme-${state.user.theme}`;
            const steps = skill.newSteps || [];
            const idx = steps.indexOf(state.currentStep);
            
            let content = '';
            let stepTitle = skill.name;
            let stepNumber = idx + 1;
            let totalSteps = steps.length;
            
            // Helper for progress dots
            const progressDots = steps.map((_, i) => 
                `<div class="flex-1 h-2 rounded-full ${i <= idx ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-gray-300'}"></div>`
            ).join('');
            
            // ====== SPECIAL HANDLING FOR SKILL 7 (CHECKIN) ======
            if (skill.id === 'checkin' && state.currentStep === 'experience') {
                stepTitle = skill.experience.title;
                content = `
                    <div class="space-y-6 fade-in">
                        <div class="skill-${skill.id} rounded-2xl p-6 text-white">
                            <div class="text-5xl mb-3">${skill.hook.visual}</div>
                            <h2 class="text-xl font-bold mb-2">${skill.experience.title}</h2>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 text-center">
                            <p class="text-lg font-bold text-gray-800 mb-6">How are you right now?</p>
                            <button onclick="document.getElementById('autoResponse').classList.remove('hidden'); this.classList.add('hidden')" 
                                    class="w-full bg-gradient-to-r ${skill.color} text-white py-6 rounded-xl font-bold text-2xl shadow-lg hover:opacity-90 transition-all mb-6">
                                I'm fine
                            </button>
                            <p class="text-gray-600 text-sm">Click without thinking. Give your automatic answer.</p>
                        </div>
                        
                        <div id="autoResponse" class="hidden space-y-6">
                            <div class="bg-white rounded-2xl p-6">
                                <p class="font-bold text-gray-800 mb-4">Was that actually accurate?</p>
                                <div class="grid grid-cols-2 gap-2 mb-4">
                                    ${skill.experience.checkboxes.map(item => `
                                        <label class="flex items-center gap-2 p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                            <input type="checkbox" class="w-5 h-5 ${skill.color.replace('from-', 'text-').replace(' to-', '')} rounded">
                                            <span class="text-gray-700">${item}</span>
                                        </label>
                                    `).join('')}
                                </div>
                                
                                <p class="font-bold text-gray-800 mb-3">${skill.experience.reflectionPrompt}</p>
                                <input type="text" 
                                       id="experienceReflection"
                                       class="w-full p-4 rounded-xl border-2 border-gray-300 focus:border-teal-500" 
                                       placeholder="e.g., 'I just said what I always say'">
                            </div>
                            
                            <button onclick="completeExperienceStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all">
                                Continue ‚Üí Earn ${15 * state.user.comboMultiplier} Coins
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // ====== SPECIAL HANDLING FOR SKILL 6 (EFFECTIVELY) ======
            else if (skill.id === 'effectively' && state.currentStep === 'practice') {
                stepTitle = skill.practice.title;
                content = `
                    <div class="space-y-6 fade-in">
                        <div class="skill-${skill.id} rounded-2xl p-6 text-white">
                            <h2 class="text-xl font-bold mb-2">${skill.practice.title}</h2>
                            <p class="opacity-90 text-sm">Discover what you actually want</p>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6">
                            <p class="text-gray-700 mb-4">${skill.practice.instructions}</p>
                            
                            <div class="grid grid-cols-2 gap-2 mb-6">
                                ${['To feel heard', 'To stay connected', 'To solve the problem', 'To preserve peace', 'To be understood', 'To move forward together'].map(goal => `
                                    <label class="flex items-center gap-2 p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                        <input type="radio" name="realGoal" value="${goal}" class="w-5 h-5 ${skill.color.replace('from-', 'text-').replace(' to-', '')} rounded">
                                        <span class="text-gray-700">${goal}</span>
                                    </label>
                                `).join('')}
                            </div>
                            
                            <p class="font-bold text-gray-800 mb-3">${skill.practice.ratingPrompt}</p>
                            <div class="mb-6">
                                <div class="flex items-center gap-4 mb-4">
                                    <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center text-red-700 font-bold">
                                        ‚ùå
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-gray-700">Ego action: ${getWorksheetValue('ego_action') || 'Prove I was right'}</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-green-700 font-bold">
                                        ‚úÖ
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-gray-700">Effective action:</p>
                                        <input type="text" 
                                               id="effectiveAction"
                                               class="w-full p-3 rounded-lg border border-gray-300 mt-1" 
                                               placeholder="What would actually work?">
                                    </div>
                                </div>
                            </div>
                            
                            <p class="font-bold text-gray-800 mb-3">${skill.practice.wordPrompt}</p>
                            <input type="text" 
                                   id="realGoalInput"
                                   class="w-full p-4 rounded-xl border-2 border-gray-300 focus:border-pink-500" 
                                   placeholder="e.g., 'connection', 'peace', 'solution'">
                        </div>
                        
                        <button onclick="completePracticeStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all">
                            Continue ‚Üí Earn ${40 * state.user.comboMultiplier} Coins
                        </button>
                    </div>
                `;
            }
            
            // ====== STANDARD STEP RENDERING ======
            else if (state.currentStep === 'hook') {
                stepTitle = skill.hook.title;
                content = `
                    <div class="space-y-6 fade-in">
                        <div class="skill-${skill.id} rounded-2xl p-6 text-white text-center">
                            <div class="text-5xl mb-4 animate-pulse">${skill.hook.visual}</div>
                            <h2 class="text-xl font-bold mb-4">${skill.hook.title}</h2>
                            <p class="text-lg opacity-90 leading-relaxed mb-6">${skill.hook.copy}</p>
                            <button onclick="completeNewStep()" class="w-full bg-white ${getSkillTextColor(skill.id)} py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all">
                                ${skill.hook.cta}
                            </button>
                        </div>
                        <div class="text-center text-gray-600 text-sm">
                            <p>üéØ Step 1 of 7 ‚Ä¢ 30 seconds</p>
                        </div>
                    </div>
                `;
            }
            
            else if (state.currentStep === 'experience') {
                stepTitle = skill.experience.title;
                const hasTimer = skill.experience.timer > 0;
                
                content = `
                    <div class="space-y-6 fade-in">
                        <div class="skill-${skill.id} rounded-2xl p-6 text-white">
                            <div class="text-5xl mb-3">üß™</div>
                            <h2 class="text-xl font-bold mb-2">${skill.experience.title}</h2>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 space-y-4">
                            ${skill.experience.instructions.map((inst, i) => `
                                <div class="flex gap-4 items-start">
                                    <div class="w-8 h-8 ${getSkillBgColor(skill.id)} rounded-lg flex items-center justify-center text-white font-bold flex-shrink-0">
                                        ${i + 1}
                                    </div>
                                    <p class="text-gray-700 pt-1">${inst}</p>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${hasTimer ? `
                            <!-- Timer Section -->
                            <div id="timerSection" class="bg-white rounded-2xl p-6 text-center">
                                <div class="text-6xl mb-4 font-bold ${getSkillTextColor(skill.id)}" id="timerDisplay">${skill.experience.timer}</div>
                                <p class="text-gray-600 mb-4">Seconds remaining...</p>
                                <button onclick="startTimer(${skill.experience.timer})" class="w-full bg-gradient-to-r ${skill.color} text-white py-4 rounded-xl font-bold text-lg hover:opacity-90 transition-all">
                                    Start ${skill.experience.timer}-Second Timer
                                </button>
                            </div>
                        ` : `
                            <!-- No Timer Section -->
                            <div class="bg-white rounded-2xl p-6">
                                <p class="font-bold text-gray-800 mb-4">Reflect on your experience:</p>
                                <div class="grid grid-cols-2 gap-2 mb-4">
                                    ${skill.experience.checkboxes.map(item => `
                                        <label class="flex items-center gap-2 p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                            <input type="checkbox" class="w-5 h-5 ${getSkillTextColor(skill.id)} rounded">
                                            <span class="text-gray-700">${item}</span>
                                        </label>
                                    `).join('')}
                                </div>
                                
                                <p class="font-bold text-gray-800 mb-3">${skill.experience.reflectionPrompt}</p>
                                <input type="text" 
                                       id="experienceReflection"
                                       class="w-full p-4 rounded-xl border-2 border-gray-300 focus:${getSkillBorderColor(skill.id)}" 
                                       placeholder="Your reflection...">
                            </div>
                            
                            <button onclick="completeExperienceStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all">
                                Continue ‚Üí Earn ${15 * state.user.comboMultiplier} Coins
                            </button>
                        `}
                        
                        ${hasTimer ? `
                            <!-- After Timer Experience -->
                            <div id="postTimerSection" class="hidden space-y-6">
                                <div class="bg-white rounded-2xl p-6">
                                    <p class="font-bold text-gray-800 mb-4">What happened?</p>
                                    <div class="grid grid-cols-2 gap-2 mb-4">
                                        ${skill.experience.checkboxes.map(item => `
                                            <label class="flex items-center gap-2 p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                                <input type="checkbox" class="w-5 h-5 ${getSkillTextColor(skill.id)} rounded">
                                                <span class="text-gray-700">${item}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                    
                                    <p class="font-bold text-gray-800 mb-3">${skill.experience.reflectionPrompt}</p>
                                    <input type="text" 
                                           id="experienceReflection"
                                           class="w-full p-4 rounded-xl border-2 border-gray-300 focus:${getSkillBorderColor(skill.id)}" 
                                           placeholder="Your reflection...">
                                </div>
                                
                                <button onclick="completeExperienceStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all">
                                    Continue ‚Üí Earn ${15 * state.user.comboMultiplier} Coins
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            else if (state.currentStep === 'reveal') {
                stepTitle = skill.reveal.title;
                content = `
                    <div class="space-y-6 fade-in">
                        <div class="skill-${skill.id} rounded-2xl p-6 text-white">
                            <div class="text-5xl mb-3">${skill.reveal.visual}</div>
                            <h2 class="text-xl font-bold mb-2">${skill.reveal.title}</h2>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 whitespace-pre-line leading-relaxed text-gray-700">
                            ${skill.reveal.copy}
                        </div>
                        
                        <button onclick="completeNewStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all">
                            I See It Now ‚Üí Earn ${20 * state.user.comboMultiplier} Coins
                        </button>
                    </div>
                `;
            }
            
            else if (state.currentStep === 'contrast') {
                stepTitle = skill.contrast.title;
                content = `
                    <div class="space-y-6 fade-in">
                        <div class="skill-${skill.id} rounded-2xl p-6 text-white">
                            <h2 class="text-xl font-bold mb-2">${skill.contrast.title}</h2>
                            <p class="opacity-90 text-sm">Side-by-side comparison</p>
                        </div>
                        
                        <!-- Mode A -->
                        <div class="bg-white rounded-2xl p-6 border-2 border-red-200">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="text-3xl">${getModeEmoji(skill.contrast.modeA.title)}</div>
                                <div>
                                    <h3 class="font-bold text-red-700 text-lg">${skill.contrast.modeA.title}</h3>
                                    <p class="text-red-600 text-sm">The painful default</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                ${skill.contrast.modeA.steps.map((step, i) => `
                                    <div class="flex gap-3 items-start">
                                        <div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center text-red-700 font-bold text-sm flex-shrink-0 mt-1">
                                            ${i + 1}
                                        </div>
                                        <p class="text-gray-700">${step}</p>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="mt-4 p-3 bg-red-50 rounded-lg">
                                <p class="font-bold text-red-800 mb-1">Feels like:</p>
                                <p class="text-red-700">${skill.contrast.modeA.feeling}</p>
                            </div>
                        </div>
                        
                        <!-- Mode B -->
                        <div class="bg-white rounded-2xl p-6 border-2 border-green-200">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="text-3xl">${getModeEmoji(skill.contrast.modeB.title)}</div>
                                <div>
                                    <h3 class="font-bold text-green-700 text-lg">${skill.contrast.modeB.title}</h3>
                                    <p class="text-green-600 text-sm">The skillful choice</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                ${skill.contrast.modeB.steps.map((step, i) => `
                                    <div class="flex gap-3 items-start">
                                        <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center text-green-700 font-bold text-sm flex-shrink-0 mt-1">
                                            ${i + 1}
                                        </div>
                                        <p class="text-gray-700">${step}</p>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="mt-4 p-3 bg-green-50 rounded-lg">
                                <p class="font-bold text-green-800 mb-1">Feels like:</p>
                                <p class="text-green-700">${skill.contrast.modeB.feeling}</p>
                            </div>
                        </div>
                        
                        <button onclick="completeNewStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all">
                            Practice Skillful Mode ‚Üí Earn ${25 * state.user.comboMultiplier} Coins
                        </button>
                    </div>
                `;
            }
            
            else if (state.currentStep === 'practice') {
                stepTitle = skill.practice.title;
                const hasTimer = skill.practice.timer > 0;
                
                content = `
                    <div class="space-y-6 fade-in">
                        <div class="skill-${skill.id} rounded-2xl p-6 text-white">
                            <h2 class="text-xl font-bold mb-2">${skill.practice.title}</h2>
                            <p class="opacity-90 text-sm">${hasTimer ? '60 seconds of practice' : 'Guided practice'}</p>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 whitespace-pre-line leading-relaxed text-gray-700">
                            ${skill.practice.instructions}
                        </div>
                        
                        ${hasTimer ? `
                            <!-- Practice Timer -->
                            <div id="practiceTimerSection" class="bg-white rounded-2xl p-6 text-center">
                                <div class="text-6xl mb-4 font-bold ${getSkillTextColor(skill.id)}" id="practiceTimerDisplay">${skill.practice.timer}</div>
                                <p class="text-gray-600 mb-2">Focus on the practice...</p>
                                <div id="practicePrompts" class="min-h-8 mb-4">
                                    <p class="text-gray-500 italic">Ready when you are</p>
                                </div>
                                <button onclick="startPracticeTimer(${skill.practice.timer})" class="w-full bg-gradient-to-r ${skill.color} text-white py-4 rounded-xl font-bold text-lg hover:opacity-90 transition-all">
                                    Start ${skill.practice.timer}-Second Practice
                                </button>
                            </div>
                        ` : ''}
                        
                        <!-- After Practice -->
                        <div id="postPracticeSection" class="${hasTimer ? 'hidden' : ''} space-y-6">
                            <div class="bg-white rounded-2xl p-6">
                                <p class="font-bold text-gray-800 mb-4">${skill.practice.ratingPrompt}</p>
                                <div class="mb-6">
                                    <input type="range" min="1" max="10" value="5" class="w-full h-3 rounded-lg" id="practiceRating" oninput="document.getElementById('ratingValue').textContent = this.value">
                                    <div class="flex justify-between mt-2">
                                        <span class="text-gray-600">Low</span>
                                        <span id="ratingValue" class="font-black ${getSkillTextColor(skill.id)} text-xl">5</span>
                                        <span class="text-gray-600">High</span>
                                    </div>
                                </div>
                                
                                <p class="font-bold text-gray-800 mb-3">${skill.practice.wordPrompt}</p>
                                <input type="text" 
                                       id="practiceWord"
                                       class="w-full p-4 rounded-xl border-2 border-gray-300 focus:${getSkillBorderColor(skill.id)}" 
                                       placeholder="e.g., 'helpful', 'insightful', 'calming'">
                            </div>
                            
                            <button onclick="completePracticeStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all">
                                Continue ‚Üí Earn ${40 * state.user.comboMultiplier} Coins
                            </button>
                        </div>
                    </div>
                `;
            }
            
            else if (state.currentStep === 'integration') {
                stepTitle = skill.integration.title;
                const checks = getPracticeChecks(skill.id);
                content = `
                    <div class="space-y-6 fade-in">
                        <div class="skill-${skill.id} rounded-2xl p-6 text-white">
                            <h2 class="text-xl font-bold mb-2">${skill.integration.title}</h2>
                            <p class="opacity-90 text-sm">Take this into your day</p>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 space-y-6">
                            <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-4 border-2 border-amber-300">
                                <p class="font-bold text-gray-800 mb-2">${skill.integration.mission}</p>
                            </div>
                            
                            <div class="space-y-3">
                                <p class="font-bold text-gray-700">Examples:</p>
                                ${skill.integration.examples.map(ex => `
                                    <div class="p-3 bg-gray-50 rounded-xl text-gray-700">
                                        ${ex}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                                <p class="text-blue-800 whitespace-pre-line text-sm">${skill.integration.explanation}</p>
                            </div>
                            
                            <!-- Tracker -->
                            <div class="text-center">
                                <p class="text-gray-600 mb-3">Tap each time you practice today:</p>
                                <div class="grid grid-cols-5 gap-2 max-w-xs mx-auto">
                                    ${Array(skill.integration.trackerGoal).fill().map((_, i) => {
                                        const checked = checks[i];
                                        return `
                                            <div onclick="togglePracticeCheck('${skill.id}', ${i})" 
                                                 class="practice-checkbox ${checked ? 'checked' : ''} hover:scale-105 transition-transform cursor-pointer">
                                                ${checked ? '‚úì' : '+'}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Goal: ${skill.integration.trackerGoal}+ times ‚Ä¢ +${skill.integration.trackerBonus} coins each!</p>
                            </div>
                        </div>
                        
                        <button onclick="completeNewStep()" class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all">
                            Complete Skill ‚Üí Earn ${100 * state.user.comboMultiplier} Coins + Badge
                        </button>
                    </div>
                `;
            }
            
            else if (state.currentStep === 'victory') {
                stepTitle = skill.victory.title;
                content = `
                    <div class="space-y-6 text-center fade-in">
                        <div class="bg-gradient-to-r from-yellow-400 via-orange-500 to-pink-600 rounded-2xl p-8 text-white">
                            <div class="text-7xl mb-4">${skill.victory.badge.emoji}</div>
                            <h2 class="text-2xl font-black mb-2">${skill.victory.title}</h2>
                            <p class="text-lg mb-6">${skill.victory.badge.name} Earned!</p>
                            <div class="inline-block bg-white/30 px-6 py-3 rounded-2xl">
                                <span class="text-4xl mr-3">${skill.victory.badge.emoji}</span>
                                <span class="text-xl font-black">${skill.victory.badge.name}</span>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 space-y-4">
                            <h3 class="text-lg font-bold text-gray-800">What You Now Know:</h3>
                            <div class="space-y-3 text-left text-gray-700">
                                ${skill.victory.learnings.map(item => `
                                    <div class="flex gap-3">
                                        <span class="text-green-500 font-bold">‚úì</span>
                                        <span>${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-6 border-2 border-purple-200">
                            <p class="text-gray-800 italic text-lg mb-2">"${skill.victory.quote}"</p>
                            <p class="text-gray-600 text-sm">‚Äî Your new perspective</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="navigateTo('home')" class="py-4 rounded-2xl border-2 border-purple-600 text-purple-600 font-bold text-lg hover:bg-purple-50 transition-all">
                                ‚Üê Home
                            </button>
                            <button onclick="goToNextSkill()" class="py-4 rounded-2xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-lg shadow-lg hover:opacity-90 transition-all">
                                Next Skill ‚Üí
                            </button>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="min-h-screen ${themeClass} pb-32 safe-top">
                    <div class="max-w-md mx-auto p-4">
                        <!-- Progress Header -->
                        <div class="bg-white/90 rounded-2xl p-4 sticky top-0 z-10 mb-3">
                            <div class="flex items-center justify-between mb-4">
                                <button onclick="navigateTo('home')" class="text-2xl">‚Üê</button>
                                <h1 class="text-lg font-bold text-gray-800">${stepTitle}</h1>
                                <div class="bg-white/20 px-3 py-2 rounded-full flex items-center gap-2">
                                    <span class="text-xl">ü™ô</span>
                                    <span class="text-gray-800 font-bold">${state.coins}</span>
                                </div>
                            </div>
                            <div class="flex gap-1 mb-2">
                                ${progressDots}
                            </div>
                            <p class="text-gray-600 text-xs text-center">Step ${stepNumber} of ${totalSteps}</p>
                        </div>
                        
                        <!-- Main Content -->
                        <div class="bg-white rounded-2xl p-6">
                            ${content}
                        </div>
                    </div>
                    
                    ${state.showCoinAnimation ? renderCoinAnimation() : ''}
                    ${renderBottomNav()}
                </div>
            `;
        }

        // Helper functions for styling
        function getSkillTextColor(skillId) {
            const colors = {
                'observe': 'text-purple-600',
                'describe': 'text-blue-600',
                'participate': 'text-green-600',
                'nonjudgment': 'text-orange-600',
                'onemindfully': 'text-indigo-600',
                'effectively': 'text-pink-600',
                'checkin': 'text-teal-600'
            };
            return colors[skillId] || 'text-purple-600';
        }

        function getSkillBgColor(skillId) {
            const colors = {
                'observe': 'bg-gradient-to-br from-purple-500 to-pink-500',
                'describe': 'bg-gradient-to-br from-blue-500 to-cyan-500',
                'participate': 'bg-gradient-to-br from-green-500 to-emerald-500',
                'nonjudgment': 'bg-gradient-to-br from-orange-500 to-red-500',
                'onemindfully': 'bg-gradient-to-br from-indigo-500 to-purple-500',
                'effectively': 'bg-gradient-to-br from-pink-500 to-rose-500',
                'checkin': 'bg-gradient-to-br from-teal-500 to-cyan-500'
            };
            return colors[skillId] || 'bg-gradient-to-br from-purple-500 to-pink-500';
        }

        function getSkillBorderColor(skillId) {
            const colors = {
                'observe': 'border-purple-500',
                'describe': 'border-blue-500',
                'participate': 'border-green-500',
                'nonjudgment': 'border-orange-500',
                'onemindfully': 'border-indigo-500',
                'effectively': 'border-pink-500',
                'checkin': 'border-teal-500'
            };
            return colors[skillId] || 'border-purple-500';
        }

        function getModeEmoji(title) {
            if (title.includes('FIGHTER') || title.includes('DRAMA') || title.includes('GHOST') || title.includes('JUDGE') || title.includes('SCATTERED') || title.includes('EGO') || title.includes('AUTOPILOT')) {
                return '‚ùå';
            }
            return '‚úÖ';
        }

        function goToNextSkill() {
            const currentIndex = skills.findIndex(s => s.id === state.activeSkill.id);
            if (currentIndex < skills.length - 1) {
                startSkill(skills[currentIndex + 1].id);
            } else {
                navigateTo('home');
            }
        }

        // ====== MAIN SKILL RENDER DISPATCHER ======
        function renderSkillScreen() {
            // All skills now use new design
            if (state.activeSkill && state.activeSkill.newSteps) {
                return renderNewSkillScreen();
            }
            
            // Fallback
            return renderHomeScreen();
        }

        // ====== HOME SCREEN RENDER ======
        function renderHomeScreen() {
            const themeClass = `theme-${state.user.theme}`;
            const completed = state.completedSkills.length;
            const progress = Math.round((completed / skills.length) * 100);
            const randomPractice = getRandomPractice();
            const today = new Date().toDateString();
            const showDailyCheckin = dailyCheckin.lastCheckin !== today;

            return `
                <div class="min-h-screen ${themeClass} safe-top pb-20">
                    <div class="max-w-md mx-auto p-5">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center text-3xl animate-float">
                                    ${state.user.avatar}
                                </div>
                                <div>
                                    <p class="text-white/90 text-sm">Welcome back,</p>
                                    <h2 class="text-white font-bold text-lg">${state.user.name}</h2>
                                    <p class="text-white/80 text-xs">Level ${state.user.level} ‚Ä¢ ${state.user.xp} XP</p>
                                </div>
                            </div>
                            <div class="bg-white/20 px-4 py-2 rounded-full flex items-center gap-2">
                                <span class="text-xl">ü™ô</span>
                                <span class="text-white font-bold text-lg">${state.coins}</span>
                                ${state.user.comboMultiplier > 1 ? `<span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-full">${state.user.comboMultiplier}x</span>` : ''}
                            </div>
                        </div>

                        ${showDailyCheckin ? `
                            <div class="mb-6">
                                <button onclick="checkDailyCheckin()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-2xl p-4 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="text-3xl">üî•</div>
                                        <div>
                                            <p class="font-bold text-lg">Daily Check-in</p>
                                            <p class="text-white/80 text-sm">Tap for bonus coins!</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-black text-xl">+${50 * state.user.comboMultiplier} ü™ô</p>
                                        <p class="text-xs opacity-80">${dailyCheckin.streak} day streak</p>
                                    </div>
                                </button>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div class="bg-white/20 rounded-2xl p-4 text-center">
                                <p class="text-3xl font-bold text-white">${completed}/${skills.length}</p>
                                <p class="text-white/80 text-xs mt-1">Skills Mastered</p>
                            </div>
                            <div class="bg-white/20 rounded-2xl p-4 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <p class="text-3xl font-bold text-white">${state.user.consecutiveDays}</p>
                                    ${state.user.consecutiveDays >= 3 ? `<span class="text-2xl">üî•</span>` : ''}
                                </div>
                                <p class="text-white/80 text-xs mt-1">Day Streak</p>
                            </div>
                        </div>

                        <div class="bg-white/20 rounded-2xl p-5 mb-6">
                            <div class="flex justify-between text-white mb-2">
                                <p class="font-bold text-sm">Journey Progress</p>
                                <p class="font-bold text-sm">${progress}%</p>
                            </div>
                            <div class="h-3 bg-white/30 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-emerald-400 to-teal-500 rounded-full transition-all duration-1000" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        ${randomPractice ? `
                            <div class="mb-6">
                                <div class="bg-white/20 rounded-2xl p-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="text-white font-bold text-lg">üìù Today's Practice</h3>
                                        <span class="text-xs bg-purple-500 text-white px-2 py-1 rounded-full">Quick Review</span>
                                    </div>
                                    <div class="bg-white/30 rounded-xl p-3 mb-3">
                                        <p class="text-white font-bold mb-1">${randomPractice.name}</p>
                                        <p class="text-white/80 text-sm">${randomPractice.integration?.mission || 'Practice this skill today'}</p>
                                    </div>
                                    <button onclick="startSkill('${randomPractice.id}')" class="w-full bg-white/30 text-white py-2 rounded-xl text-sm font-bold">
                                        Practice Again
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-white font-bold text-xl">7 Core Mindfulness Skills</h3>
                            <button onclick="shareProgress()" class="text-white/80 text-sm bg-white/20 px-3 py-1 rounded-full">
                                Share Progress
                            </button>
                        </div>
                        <div class="space-y-3">
                            ${skills.map(skill => {
                                const done = state.completedSkills.includes(skill.id);
                                const locked = skill.prerequisite && !state.completedSkills.includes(skill.prerequisite);
                                const canAccess = !locked || done;
                                
                                return `
                                    <button onclick="${canAccess ? `startSkill('${skill.id}')` : ''}" 
                                            class="w-full bg-white rounded-2xl p-4 text-left hover:shadow-lg transition-smooth ${done ? 'border-2 border-green-400' : ''} ${!canAccess ? 'opacity-60' : ''}">
                                        <div class="flex gap-3">
                                            <div class="w-14 h-14 bg-gradient-to-br ${skill.color} rounded-xl flex items-center justify-center text-2xl flex-shrink-0">
                                                ${skill.icon}
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <h4 class="text-base font-bold text-gray-800">${skill.name}</h4>
                                                    ${done ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold">‚úì</span>' : ''}
                                                    ${locked && !done ? '<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs font-bold">üîí</span>' : ''}
                                                </div>
                                                <p class="text-gray-700 text-sm font-medium mb-1">${skill.tagline}</p>
                                                <p class="text-gray-600 text-xs">${skill.simpleExplain}</p>
                                                ${locked && !done ? `
                                                    <p class="text-xs text-red-500 mt-1">
                                                        Complete "${skills.find(s => s.id === skill.prerequisite)?.name}" first
                                                    </p>
                                                ` : ''}
                                            </div>
                                            <div class="self-center text-xl text-gray-400">${done ? 'üéâ' : (locked ? 'üîí' : '‚ñ∂Ô∏è')}</div>
                                        </div>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ${renderBottomNav()}
                </div>
            `;
        }

        // ====== SHOP SCREEN RENDER ======
        function renderShopScreen() {
            const themeClass = `theme-${state.user.theme}`;
            const ownedThemes = state.inventory.themes.length;
            const ownedAvatars = state.inventory.avatars.length;
            
            return `
                <div class="min-h-screen ${themeClass} pb-20 safe-top">
                    <div class="max-w-md mx-auto p-4">
                        <div class="bg-black/20 rounded-2xl p-6 mb-4">
                            <div class="flex items-center justify-between mb-4">
                                <button onclick="navigateTo('home')" class="text-2xl text-white">‚Üê</button>
                                <div>
                                    <h1 class="text-xl font-black text-white">Reward Shop</h1>
                                    <p class="text-white/80 text-xs mt-1">${ownedThemes} themes ‚Ä¢ ${ownedAvatars} avatars owned</p>
                                </div>
                                <div class="bg-white/20 px-3 py-2 rounded-full flex items-center gap-2">
                                    <span class="text-xl">ü™ô</span>
                                    <span class="text-white font-bold">${state.coins}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-black/20 rounded-2xl p-6 space-y-8">
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-lg font-black text-white">üé® Themes</h2>
                                    <span class="bg-white/20 px-3 py-1 rounded-full text-white text-xs font-bold">${ownedThemes}/5</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    ${shopItems.filter(i => i.type === 'theme').map(item => {
                                        const owned = isOwned(item);
                                        const active = state.user.theme === item.value;
                                        return `
                                            <button onclick="handleShopItem('${item.id}')" class="rounded-2xl overflow-hidden border-2 transition-all ${active ? 'border-yellow-400 shadow-lg' : owned ? 'border-green-400' : 'border-white/30'}">
                                                <div class="h-32 theme-${item.value} relative">
                                                    ${active ? `<div class="absolute top-2 right-2 bg-yellow-400 text-gray-900 px-2 py-1 rounded-full text-xs font-bold">ACTIVE</div>` : ''}
                                                    ${owned && !active ? `<div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-bold">OWNED</div>` : ''}
                                                </div>
                                                <div class="p-3 bg-black/40">
                                                    <p class="text-white font-bold text-center text-sm mb-1">${item.name}</p>
                                                    ${owned ? 
                                                        `<p class="text-green-300 text-center text-xs font-bold">‚úì Equippable</p>` : 
                                                        `<div class="text-center">
                                                            <p class="text-yellow-300 font-bold text-sm mb-1">${item.cost} ü™ô</p>
                                                            ${state.coins >= item.cost ? 
                                                                `<p class="text-green-300 text-xs font-bold">Can afford</p>` : 
                                                                `<p class="text-red-300 text-xs font-bold">Need ${item.cost - state.coins} more</p>`
                                                            }
                                                        </div>`
                                                    }
                                                </div>
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-lg font-black text-white">üë§ Avatars</h2>
                                    <span class="bg-white/20 px-3 py-1 rounded-full text-white text-xs font-bold">${ownedAvatars}/7</span>
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    ${shopItems.filter(i => i.type === 'avatar').map(item => {
                                        const owned = isOwned(item);
                                        const active = state.user.avatar === item.value;
                                        return `
                                            <button onclick="handleShopItem('${item.id}')" class="p-4 rounded-2xl bg-black/40 border-2 transition-all text-center ${active ? 'border-yellow-400 shadow-lg' : owned ? 'border-green-400' : 'border-white/30'}">
                                                <div class="text-4xl mb-2">${item.value}</div>
                                                <p class="text-white font-bold text-xs mb-1">${item.name}</p>
                                                ${owned ? 
                                                    `<p class="text-green-300 text-xs font-bold">‚úì</p>` : 
                                                    `<div>
                                                        <p class="text-yellow-300 font-bold text-sm mb-1">${item.cost} ü™ô</p>
                                                        ${state.coins >= item.cost ? 
                                                            `<p class="text-green-300 text-xs font-bold">‚úì</p>` : 
                                                            `<p class="text-red-300 text-xs font-bold">‚úó</p>`
                                                        }
                                                    </div>`
                                                }
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <div class="text-center pt-4 border-t border-white/20">
                                <p class="text-white/70 mb-3 text-sm">Want more coins?</p>
                                <button onclick="navigateTo('home')" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-2xl text-sm">
                                    Practice Mindfulness Skills ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                    ${renderBottomNav()}
                </div>
            `;
        }

        // ====== PROFILE SCREEN RENDER ======
        function renderProfileScreen() {
            const themeClass = `theme-${state.user.theme}`;
            const completed = state.completedSkills.length;
            const showJournal = journalEntries.length > 0;
            
            return `
                <div class="min-h-screen ${themeClass} pb-20 safe-top">
                    <div class="max-w-md mx-auto p-4">
                        <div class="bg-black/20 rounded-2xl p-6 mb-4">
                            <div class="flex items-center justify-between">
                                <button onclick="navigateTo('home')" class="text-2xl text-white">‚Üê</button>
                                <h1 class="text-xl font-black text-white">Your Profile</h1>
                                <button onclick="shareProgress()" class="text-white text-sm bg-white/20 px-3 py-1 rounded-full">
                                    Share
                                </button>
                            </div>
                        </div>
                        <div class="bg-black/20 rounded-2xl p-6 space-y-8">
                            <div class="text-center">
                                <div class="w-32 h-32 rounded-full bg-white/20 mx-auto mb-4 flex items-center justify-center text-6xl animate-float">
                                    ${state.user.avatar}
                                </div>
                                <h2 class="text-2xl font-black text-white mb-2">${state.user.name}</h2>
                                <div class="bg-white/20 px-4 py-2 rounded-full inline-flex items-center gap-2">
                                    <span class="text-xl text-yellow-400">‚òÖ</span>
                                    <span class="text-white font-bold">Level ${state.user.level}</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-white/20 rounded-2xl p-4 text-center">
                                    <p class="text-3xl font-black text-white">${completed}/7</p>
                                    <p class="text-white/80 mt-1 text-xs">Skills Mastered</p>
                                </div>
                                <div class="bg-white/20 rounded-2xl p-4 text-center">
                                    <p class="text-3xl font-black text-white">${state.coins}</p>
                                    <p class="text-white/80 mt-1 text-xs">Total Coins</p>
                                </div>
                                <div class="bg-white/20 rounded-2xl p-4 text-center">
                                    <p class="text-3xl font-black text-white">${state.user.xp}</p>
                                    <p class="text-white/80 mt-1 text-xs">Lifetime XP</p>
                                </div>
                                <div class="bg-white/20 rounded-2xl p-4 text-center">
                                    <div class="flex items-center justify-center gap-1">
                                        <p class="text-3xl font-black text-white">${state.user.consecutiveDays}</p>
                                        ${state.user.consecutiveDays >= 3 ? `<span class="text-2xl">üî•</span>` : ''}
                                    </div>
                                    <p class="text-white/80 mt-1 text-xs">Day Streak</p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-black text-white mb-4">üèÜ Your Badge Collection</h3>
                                ${state.inventory.badges.length > 0 ? `
                                    <div class="grid grid-cols-3 gap-3">
                                        ${state.inventory.badges.map(b => `
                                            <div class="bg-white/20 rounded-2xl p-4 text-center">
                                                <div class="text-4xl mb-2">${b.emoji}</div>
                                                <p class="text-white font-bold text-xs">${b.name}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center py-8">
                                        <div class="text-6xl mb-4 opacity-50">üèÜ</div>
                                        <p class="text-white/80 mb-4">Complete skills to earn your first badge!</p>
                                        <button onclick="navigateTo('home')" class="px-6 py-3 bg-white/20 rounded-2xl text-white font-bold text-sm">
                                            Start Training
                                        </button>
                                    </div>
                                `}
                            </div>
                            ${showJournal ? `
                                <div>
                                    <h3 class="text-lg font-black text-white mb-4">üìñ My Journal</h3>
                                    <div class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                        ${journalEntries.slice(-5).reverse().map(entry => {
                                            const date = new Date(entry.date).toLocaleDateString();
                                            return `
                                                <div class="bg-white/10 rounded-xl p-4">
                                                    <div class="flex justify-between items-start mb-2">
                                                        <h4 class="text-white font-bold">${entry.skill}</h4>
                                                        <span class="text-white/60 text-xs">${date}</span>
                                                    </div>
                                                    <p class="text-white/80 text-sm line-clamp-2">
                                                        ${Object.values(entry.responses).slice(0, 1).join(' ').substring(0, 80)}...
                                                    </p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    <p class="text-white/60 text-xs mt-2 text-center">${journalEntries.length} total reflections</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ${renderBottomNav()}
                </div>
            `;
        }

        // ====== MAIN RENDER FUNCTION ======
        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            
            if (state.screen === 'skill') {
                app.innerHTML = renderSkillScreen();
            } else if (state.screen === 'shop') {
                app.innerHTML = renderShopScreen();
            } else if (state.screen === 'profile') {
                app.innerHTML = renderProfileScreen();
            } else {
                app.innerHTML = renderHomeScreen();
            }
        }

        // ====== Initialize ======
        loadState();
        updateDailyStreak();
        
        // Auto-unlock all skills for testing
        state.completedSkills = ['observe', 'describe', 'participate', 'nonjudgment'];
        state.coins = 1000;
        
        render();
    </script>
</body>
</html>
