<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindPath - Complete Mindfulness Training</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
       
        * {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
       
        body {
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
        }
       
        /* Improved contrast */
        .skill-card h4 {
            color: #1f2937 !important;
        }
       
        .action-button {
            color: white !important;
            font-weight: 700 !important;
        }
       
        /* ANTI-FREEZE FIX: Textarea optimization */
        textarea.no-freeze {
            will-change: contents;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            font-size: 16px !important;
            background: white !important;
            color: #1f2937 !important;
            border: 2px solid #d1d5db !important;
        }
       
        textarea.no-freeze:focus {
            border-color: #7c3aed !important;
            outline: none !important;
        }
        
        input[type="text"], input[type="range"] {
            background: white !important;
            color: #1f2937 !important;
            border: 2px solid #d1d5db !important;
            font-size: 16px !important;
        }
       
        input[type="text"]:focus, input[type="range"]:focus {
            border-color: #7c3aed !important;
            outline: none !important;
        }
       
        .bottom-nav {
            padding-bottom: env(safe-area-inset-bottom);
            background: #ffffff;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            border-top: 1px solid #e5e7eb;
        }
       
        .nav-badge {
            position: absolute;
            top: 0px;
            right: 12px;
            background: #dc2626;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 12px;
            min-width: 20px;
            height: 20px;
            text-align: center;
            line-height: 1;
            border: 2px solid white;
        }
       
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
       
        .glow {
            box-shadow: 0 4px 25px rgba(139, 92, 246, 0.2);
        }
       
        .glow:hover {
            box-shadow: 0 8px 35px rgba(139, 92, 246, 0.3);
        }
       
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
       
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
       
        @keyframes coin-pop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
       
        .animate-coin-pop {
            animation: coin-pop 0.8s ease-out;
        }
       
        /* Theme backgrounds */
        .theme-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #db2777 100%);
        }
       
        .theme-ocean {
            background: linear-gradient(135deg, #1e40af 0%, #0ea5e9 50%, #22d3ee 100%);
        }
       
        .theme-sunset {
            background: linear-gradient(135deg, #dc2626 0%, #ea580c 50%, #f59e0b 100%);
        }
       
        .theme-forest {
            background: linear-gradient(135deg, #065f46 0%, #10b981 50%, #34d399 100%);
        }
       
        .theme-midnight {
            background: linear-gradient(135deg, #1e1b4b 0%, #3730a3 50%, #6366f1 100%);
        }
       
        .theme-rose {
            background: linear-gradient(135deg, #be185d 0%, #db2777 50%, #f472b6 100%);
        }
       
        /* Glass effects */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
       
        .glass-dark {
            background: rgba(15, 23, 42, 0.92);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
       
        /* Mobile-friendly touch targets */
        button, .clickable {
            min-height: 44px;
            min-width: 44px;
        }
       
        /* Better text contrast */
        .text-contrast {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
       
        /* Purchase confirmation animation */
        @keyframes purchase-confirm {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
       
        .purchase-confirm {
            animation: purchase-confirm 0.5s ease-out;
        }
       
        /* Improved slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            height: 10px;
            border-radius: 5px;
            background: #e5e7eb;
        }
       
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #7c3aed;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
       
        /* Safe area for notches */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
       
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
       
        /* Prevent horizontal scroll */
        .no-horizontal-scroll {
            max-width: 100%;
            overflow-x: hidden;
        }
       
        /* Responsive text sizes */
        @media (max-width: 380px) {
            .text-responsive {
                font-size: 0.9rem;
            }
           
            .text-responsive-lg {
                font-size: 1.1rem;
            }
           
            .text-responsive-xl {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen no-horizontal-scroll"></div>
    
    <!-- Purchase Notification Modal -->
    <div id="purchaseModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="z-index: 9999;">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="relative bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl purchase-confirm">
            <div class="text-center">
                <div class="text-6xl mb-4">üéâ</div>
                <h3 class="text-xl font-bold text-gray-800 mb-3" id="purchaseTitle"></h3>
                <p class="text-gray-600 mb-6 text-sm" id="purchaseMessage"></p>
                <button onclick="closePurchaseModal()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-2xl font-bold text-lg shadow-lg">
                    Awesome!
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ====== ANTI-FREEZE SOLUTION ======
        let textareaCache = {};
        let renderTimeout = null;
        
        // State remains the same
        let state = {
            coins: 250,
            user: {
                avatar: 'üòä',
                theme: 'gradient',
                level: 1,
                xp: 0,
                streak: 0,
                totalPractices: 0,
                name: 'Mindful Explorer'
            },
            activeSkill: null,
            currentStep: 'intro',
            worksheetData: {},
            showCoinAnimation: false,
            coinAmount: 0,
            screen: 'home',
            completedSkills: [],
            inventory: {
                themes: ['gradient'],
                avatars: ['üòä'],
                badges: []
            },
            unreadShopItems: 3,
            purchaseHistory: [],
            lastPurchase: null
        };

        // FULL DETAILED SKILLS - kept all content exactly as provided
        const skills = [
            {
                id: 'observe',
                name: 'Observe',
                icon: 'üëÅÔ∏è',
                color: 'from-purple-600 to-pink-600',
                tagline: 'Watch thoughts like clouds drifting by',
                simpleExplain: 'Notice thoughts, feelings, and sensations without trying to change or fight them',
                experienceFirst: {
                    title: 'üß™ Try This Quick Experiment',
                    subtitle: '30 seconds of honest effort',
                    instructions: [
                        'Close your eyes gently',
                        'Try as hard as you can to stop ALL thoughts',
                        'Force your mind to stay completely blank',
                        'Push away every single thought that appears',
                        'Keep trying for 30 seconds...'
                    ],
                    prompt: 'What actually happened? Were you able to stop thinking completely?'
                },
                revelation: {
                    title: 'üí° The Powerful Insight',
                    insight: 'You just proved something profound: the harder you fight thoughts, the stronger they become.\n\nIt\'s like quicksand ‚Äî struggling only pulls you deeper.\n\nThis isn\'t because your mind is broken. It happens to everyone. The brain is designed to think, just like the heart is designed to beat.\n\nThe skill isn\'t suppression ‚Äî it\'s gentle observation.',
                    analogy: {
                        title: 'üé¨ Movie Theater Mind',
                        text: 'Picture yourself in a cinema. Thoughts are scenes playing on the screen.\nYou don\'t jump up to wrestle the characters or rewrite the script.\nYou simply watch, curious and calm.\nThat\'s observing.'
                    },
                    skillExplained: 'Observe means becoming a neutral witness to your inner world ‚Äî noticing thoughts, emotions, and body sensations as they arise and pass, without judgment or interference.'
                },
                modeA: {
                    title: '‚ùå Fighter Mode',
                    emoji: 'ü•ä',
                    steps: [
                        'Spot a thought you don\'t like',
                        'Immediately try to push it away',
                        'Tell yourself "Stop thinking that!"',
                        'Feel tension and frustration rise',
                        'Thoughts multiply and intensify',
                        'End up exhausted and overwhelmed'
                    ],
                    feeling: 'üò´ Draining, frustrating, endless battle'
                },
                modeB: {
                    title: '‚úÖ Observer Mode',
                    emoji: 'üëÅÔ∏è',
                    steps: [
                        'Notice a thought arising',
                        'Silently label it: "thinking" or "planning"',
                        'Watch it like a cloud floating across the sky',
                        'Let it drift and dissolve on its own',
                        'Return gently to the present moment',
                        'Feel spaciousness return'
                    ],
                    feeling: 'üòå Light, peaceful, spacious'
                },
                worksheet: [
                    { q: 'Describe what happened when you tried to force thoughts away', type: 'textarea' },
                    { q: 'How stressful did Fighter Mode feel? (1‚Äì10)', type: 'slider', min: 1, max: 10 },
                    { q: 'Now try Observer Mode for 1 minute ‚Äî just watch thoughts pass. What was different?', type: 'textarea' },
                    { q: 'How calm did Observer Mode feel? (1‚Äì10)', type: 'slider', min: 1, max: 10 }
                ],
                realWorld: {
                    mission: 'For the next few hours, every time you notice an emotion, silently say: "I\'m noticing [emotion]"',
                    examples: [
                        'üò§ Irritated ‚Üí "Noticing irritation"',
                        'üòü Anxious ‚Üí "Noticing anxiety"',
                        'üòä Content ‚Üí "Noticing contentment"'
                    ],
                    trackerHint: 'Notice 5+ times today to really feel the shift'
                },
                badge: { emoji: 'üëÅÔ∏è', name: 'Quiet Observer', color: 'purple' }
            },
            {
                id: 'describe',
                name: 'Describe',
                icon: 'üìù',
                color: 'from-blue-600 to-cyan-600',
                tagline: 'Stick to facts ‚Äî drop the drama',
                simpleExplain: 'Report only what actually happened, without adding judgmental or exaggerated stories',
                experienceFirst: {
                    title: 'üß™ Try This Quick Experiment',
                    subtitle: 'Listen to your inner narrator',
                    instructions: [
                        'Recall a recent frustrating or upsetting situation',
                        'Notice the exact words your mind uses to describe it',
                        'Pay attention to dramatic labels like "disaster," "always," "ruined," "unbearable"',
                        'Feel how your body responds to those words'
                    ],
                    prompt: 'How did your body feel when you added all that drama?'
                },
                revelation: {
                    title: 'üí° The Powerful Insight',
                    insight: 'Your words create extra suffering on top of the event itself.\n\nThe situation caused one layer of pain.\nThe dramatic story you tell about it adds a second, unnecessary layer.\n\nBy sticking to pure facts, you keep the pain manageable and your mind clear.',
                    analogy: {
                        title: 'üì∞ News Reporter vs Soap Opera',
                        text: 'A neutral reporter states only verifiable facts.\nA soap opera adds music, exaggeration, and endless drama.\nYour mind often defaults to soap-opera mode ‚Äî but you can switch to reporter mode.'
                    },
                    skillExplained: 'Describe means narrating events like a calm, objective reporter ‚Äî only observable facts, no opinions or emotional adjectives.'
                },
                modeA: {
                    title: '‚ùå Drama Mode',
                    emoji: 'üé≠',
                    steps: [
                        'Something happens',
                        'Mind adds extreme labels: "catastrophe," "always," "never," "should"',
                        'Story escalates: "This proves I\'m a failure"',
                        'Body tenses, emotions intensify',
                        'Situation feels heavier and more overwhelming'
                    ],
                    feeling: 'üò∞ Heavy, spiraling, overwhelming'
                },
                modeB: {
                    title: '‚úÖ Reporter Mode',
                    emoji: 'üì∞',
                    steps: [
                        'Something happens',
                        'State only what is observable: "This occurred"',
                        'Remove opinions, judgments, absolutes',
                        'Body stays calmer, mind stays clear',
                        'Problem becomes solvable instead of endless'
                    ],
                    feeling: 'üòä Clear, grounded, manageable'
                },
                worksheet: [
                    { q: 'Write the full dramatic version of a recent upsetting event', type: 'textarea' },
                    { q: 'How tense or heavy did that feel? (1‚Äì10)', type: 'slider', min: 1, max: 10 },
                    { q: 'Now rewrite it using ONLY observable facts ‚Äî no opinions or drama', type: 'textarea' },
                    { q: 'How much lighter or clearer does this version feel? (1‚Äì10)', type: 'slider', min: 1, max: 10 }
                ],
                realWorld: {
                    mission: 'Catch yourself using "always," "never," "should," or catastrophic words. Pause and rephrase with pure facts.',
                    examples: [
                        '‚ùå "I always screw this up" ‚Üí ‚úÖ "I made a mistake this time"',
                        '‚ùå "They never listen to me" ‚Üí ‚úÖ "They didn\'t respond to my last message"',
                        '‚ùå "This is a disaster" ‚Üí ‚úÖ "This outcome was not what I wanted"'
                    ],
                    trackerHint: 'Rephrase at least 3 times today'
                },
                badge: { emoji: 'üì∞', name: 'Clear Reporter', color: 'blue' }
            },
            {
                id: 'participate',
                name: 'Participate',
                icon: 'üåø',
                color: 'from-green-600 to-emerald-600',
                tagline: 'Be fully where your feet are',
                simpleExplain: 'Bring your full attention to whatever you\'re doing right now',
                experienceFirst: {
                    title: 'üß™ Try This Quick Experiment',
                    subtitle: 'Ghost walk vs fully embodied walk',
                    instructions: [
                        'Stand up and slowly walk across the room',
                        'Let your mind wander freely ‚Äî think about plans, worries, memories',
                        'Don\'t try to focus on the walking at all',
                        'Continue for 30‚Äì60 seconds'
                    ],
                    prompt: 'Did you feel your feet touching the ground? The temperature of the air? Your breathing? How "real" did the experience feel?'
                },
                revelation: {
                    title: 'üí° The Powerful Insight',
                    insight: 'Your body was moving, but your mind was elsewhere ‚Äî you were physically present but mentally absent.\n\nLife only happens in the present moment. When the mind wanders to past or future, you miss the richness of now.\n\nFull participation turns ordinary moments into vivid experiences.',
                    analogy: {
                        title: 'üéÆ Playing a Game While Scrolling Your Phone',
                        text: 'You\'d miss the entire adventure, the excitement, the beauty.\nLife is the same ‚Äî when you\'re mentally elsewhere, you\'re not truly living it.'
                    },
                    skillExplained: 'Participate means bringing your mind fully into the current activity ‚Äî engaging all your senses in what\'s happening right here, right now.'
                },
                modeA: {
                    title: '‚ùå Ghost Mode',
                    emoji: 'üëª',
                    steps: [
                        'Body performs an action',
                        'Mind drifts to past regrets or future plans',
                        'Sensations go unnoticed',
                        'Time passes in a blur',
                        'Life feels flat and disconnected'
                    ],
                    feeling: 'üò∂‚Äçüå´Ô∏è Numb, distant, half-alive'
                },
                modeB: {
                    title: '‚úÖ Fully Present Mode',
                    emoji: 'üåø',
                    steps: [
                        'Body performs an action',
                        'Mind notices sensations: touch, temperature, movement',
                        'When mind wanders, gently return attention',
                        'Engage all senses fully',
                        'Experience becomes vivid and rich'
                    ],
                    feeling: '‚ú® Alive, connected, vibrant'
                },
                worksheet: [
                    { q: 'What was your mind thinking about during the ghost walk?', type: 'textarea' },
                    { q: 'How present or "real" did the walk feel? (1‚Äì10)', type: 'slider', min: 1, max: 10 },
                    { q: 'Walk again, this time noticing every sensation in your feet, legs, breath. Describe the difference.', type: 'textarea' },
                    { q: 'How alive and present did this feel? (1‚Äì10)', type: 'slider', min: 1, max: 10 }
                ],
                realWorld: {
                    mission: 'Choose one ordinary daily activity and do it with 100% focused attention ‚Äî no multitasking.',
                    examples: [
                        'üçΩÔ∏è Washing dishes ‚Äî feel water temperature, soap texture, sounds',
                        'üö∂ Walking ‚Äî notice each footfall, air on skin',
                        'üçé Eating ‚Äî taste, smell, texture of every bite'
                    ],
                    trackerHint: 'Do this fully at least twice today'
                },
                badge: { emoji: 'üåø', name: 'Fully Present', color: 'green' }
            },
            {
                id: 'nonjudgment',
                name: 'Nonjudgmentally',
                icon: '‚öñÔ∏è',
                color: 'from-orange-600 to-red-600',
                tagline: 'Just notice ‚Äî no "good" or "bad" needed',
                simpleExplain: 'Observe experiences exactly as they are, without adding labels or self-criticism',
                experienceFirst: {
                    title: 'üß™ Try This Quick Experiment',
                    subtitle: 'Feel the weight of judgment',
                    instructions: [
                        'Recall a recent mistake, setback, or flaw',
                        'Add harsh labels: "I\'m stupid," "I\'m a failure," "This is unacceptable"',
                        'Really lean into how "bad" or "wrong" it was',
                        'Keep judging for 30 seconds'
                    ],
                    prompt: 'Where did you feel the judgment in your body? How heavy did it make everything?'
                },
                revelation: {
                    title: 'üí° The Powerful Insight',
                    insight: 'The original event caused one pain.\nJudgment adds a second, ongoing pain ‚Äî like getting hit by an arrow, then shooting yourself with another.\nDropping judgment doesn\'t mean approving everything. It means stopping the self-inflicted suffering so you can learn and move forward.',
                    analogy: {
                        title: 'üî¨ Scientist vs Harsh Critic',
                        text: 'A scientist observes an experiment\'s results without personal attack.\nA critic shames themselves for "failing."\nNonjudgment lets you gather clear data and improve.'
                    },
                    skillExplained: 'Nonjudgmentally means seeing reality clearly ‚Äî what happened, without layering on "good/bad," "should/shouldn\'t," or personal attacks.'
                },
                modeA: {
                    title: '‚ùå Judging Mode',
                    emoji: '‚öñÔ∏è',
                    steps: [
                        'Something happens that you don\'t like',
                        'Mind adds labels: "bad," "wrong," "failure"',
                        'Self-attack begins: "I\'m terrible"',
                        'Shame and stuckness grow',
                        'Learning and change become impossible'
                    ],
                    feeling: 'üòû Heavy shame, stuck, hopeless'
                },
                modeB: {
                    title: '‚úÖ Scientist Mode',
                    emoji: 'üî¨',
                    steps: [
                        'Something happens',
                        'Observe facts only: "This occurred"',
                        'Note contributing factors without blame',
                        'Mind stays clear and curious',
                        'Space opens for learning and growth'
                    ],
                    feeling: 'üåü Light, curious, forward-moving'
                },
                worksheet: [
                    { q: 'Write the full judgmental version of a recent difficult event', type: 'textarea' },
                    { q: 'How painful or heavy did the judgment make it feel? (1‚Äì10)', type: 'slider', min: 1, max: 10 },
                    { q: 'Now write only the neutral facts ‚Äî no labels or opinions', type: 'textarea' },
                    { q: 'How much lighter or clearer does this feel? (1‚Äì10)', type: 'slider', min: 1, max: 10 }
                ],
                realWorld: {
                    mission: 'When judgment arises, silently note "Judging," then state one neutral fact.',
                    examples: [
                        '‚ùå "I\'m so lazy" ‚Üí "Judging" ‚Üí ‚úÖ "I haven\'t started that task yet"',
                        '‚ùå "This is awful" ‚Üí "Judging" ‚Üí ‚úÖ "This situation is challenging"'
                    ],
                    trackerHint: 'Catch and reframe judgment 5+ times today'
                },
                badge: { emoji: 'üî¨', name: 'Nonjudging Mind', color: 'orange' }
            },
            {
                id: 'onemindfully',
                name: 'One-Mindfully',
                icon: 'üéØ',
                color: 'from-indigo-600 to-purple-600',
                tagline: 'One thing, fully and completely',
                simpleExplain: 'Give your full attention to one activity at a time',
                experienceFirst: {
                    title: 'üß™ Try This Quick Experiment',
                    subtitle: 'The myth of multitasking',
                    instructions: [
                        'Count backwards from 100 by 7s (100, 93, 86‚Ä¶)',
                        'Simultaneously list 5 items currently in your fridge',
                        'Also plan what you\'ll do this evening',
                        'Keep all three tasks going actively for 30‚Äì60 seconds'
                    ],
                    prompt: 'How well did you perform any of the tasks? How did your brain feel?'
                },
                revelation: {
                    title: 'üí° The Powerful Insight',
                    insight: 'Your brain cannot truly multitask ‚Äî it rapidly switches focus, losing time and accuracy with every switch.\nResearch shows task-switching can waste up to 40% of productive time.\nMasters in any field succeed through deep, single-pointed focus.',
                    analogy: {
                        title: 'üç≥ Master Chef vs Frenzied Cook',
                        text: 'A master chef gives full attention to one dish at a time ‚Äî perfection results.\nTrying five dishes at once burns everything.\nOne-mindfully creates excellence.'
                    },
                    skillExplained: 'One-mindfully means doing one thing at a time with complete, undistracted attention ‚Äî closing tabs, silencing notifications, and being fully immersed.'
                },
                modeA: {
                    title: '‚ùå Scattered Mode',
                    emoji: 'üåÄ',
                    steps: [
                        'Attempt multiple tasks simultaneously',
                        'Brain ping-pongs rapidly between them',
                        'Lose focus and energy with each switch',
                        'Accomplish little while feeling busy',
                        'End exhausted with mediocre results'
                    ],
                    feeling: 'üòµ‚Äçüí´ Frazzled, tired, ineffective'
                },
                modeB: {
                    title: '‚úÖ Laser Mode',
                    emoji: 'üéØ',
                    steps: [
                        'Choose one task',
                        'Remove all distractions',
                        'Give it 100% of your attention',
                        'When mind wanders, gently return',
                        'Complete with clarity and quality'
                    ],
                    feeling: 'üòå Clear, accomplished, energized'
                },
                worksheet: [
                    { q: 'Describe your experience trying to juggle the three tasks', type: 'textarea' },
                    { q: 'How scattered or overwhelmed did you feel? (1‚Äì10)', type: 'slider', min: 1, max: 10 },
                    { q: 'Now pick ONE simple task and do it for 2 minutes with full attention. Describe how it felt.', type: 'textarea' },
                    { q: 'How focused and satisfying was that? (1‚Äì10)', type: 'slider', min: 1, max: 10 }
                ],
                realWorld: {
                    mission: 'Eat one full meal today with ZERO distractions ‚Äî no screens, no reading, no planning.',
                    examples: [
                        'Notice smell, flavor, texture of each bite',
                        'Chew slowly and thoroughly',
                        'Stay fully with the experience of eating'
                    ],
                    trackerHint: 'Do this mindfully at least once today'
                },
                badge: { emoji: 'üéØ', name: 'Laser Focus', color: 'indigo' }
            },
            {
                id: 'effectively',
                name: 'Effectively',
                icon: '‚úÖ',
                color: 'from-pink-600 to-rose-600',
                tagline: 'Do what works ‚Äî not what feels "right"',
                simpleExplain: 'Choose actions that achieve your real goal, even if ego doesn\'t like it',
                experienceFirst: {
                    title: 'üß™ Try This Quick Experiment',
                    subtitle: 'Feel the pull of being right',
                    instructions: [
                        'Recall a recent disagreement or conflict',
                        'Notice the strong urge to prove you were right',
                        'Feel the tension of defending your position',
                        'Imagine doubling down to win the argument'
                    ],
                    prompt: 'Did being "right" actually help achieve what you really wanted?'
                },
                revelation: {
                    title: 'üí° The Powerful Insight',
                    insight: 'Winning the battle of "who\'s right" often costs you the war ‚Äî peace, connection, or real progress.\nEffectiveness asks: "What action will actually get me closer to my goal?"\nSometimes the most effective move is letting go of ego.',
                    analogy: {
                        title: '‚ôüÔ∏è Strategic Chess Player',
                        text: 'Arguing about the rules mid-game might make you "right," but you lose the match.\nA master player chooses moves that win the game, regardless of pride.'
                    },
                    skillExplained: 'Effectively means prioritizing real-world results over being right, looking good, or following rigid principles.'
                },
                modeA: {
                    title: '‚ùå Ego Mode',
                    emoji: 'üëë',
                    steps: [
                        'Goal becomes "be right" or "win"',
                        'Defend position at all costs',
                        'Escalate conflict to prove point',
                        'Relationship or outcome suffers',
                        'Feel temporarily victorious but ultimately empty'
                    ],
                    feeling: 'üò§ Tense, stuck, isolated'
                },
                modeB: {
                    title: '‚úÖ Strategy Mode',
                    emoji: '‚ôüÔ∏è',
                    steps: [
                        'Clarify true goal (connection? solution? peace?)',
                        'Ask "What action serves that goal best?"',
                        'Choose effectiveness over ego',
                        'Act accordingly, even if it means yielding',
                        'Achieve meaningful outcome'
                    ],
                    feeling: 'üòä Calm, connected, satisfied'
                },
                worksheet: [
                    { q: 'Describe a recent conflict and your need to be right', type: 'textarea' },
                    { q: 'How stressful or stuck did it feel? (1‚Äì10)', type: 'slider', min: 1, max: 10 },
                    { q: 'What was your actual deeper goal in that situation?', type: 'text' },
                    { q: 'What action would have been most effective for reaching that goal?', type: 'textarea' }
                ],
                realWorld: {
                    mission: 'In your next disagreement or urge to defend, pause and ask: "What will actually work here?"',
                    examples: [
                        'Instead of proving you\'re right ‚Üí Ask "What outcome do we both want?"',
                        'Instead of winning the point ‚Üí Seek understanding or compromise'
                    ],
                    trackerHint: 'Apply this at least once today'
                },
                badge: { emoji: '‚ôüÔ∏è', name: 'Wise Strategist', color: 'pink' }
            },
            {
                id: 'checkin',
                name: 'Check-In',
                icon: 'üß†',
                color: 'from-teal-600 to-cyan-600',
                tagline: 'Know your inner state before acting',
                simpleExplain: 'Pause briefly to scan mood, body, and energy before responding',
                experienceFirst: {
                    title: 'üß™ Try This Quick Experiment',
                    subtitle: 'Automatic pilot response',
                    instructions: [
                        'Without any pause or checking, immediately answer out loud: "I\'m fine"',
                        'Don\'t look inward at all',
                        'Just give the default, habitual response'
                    ],
                    prompt: 'Was that actually accurate? Did you even know how you truly felt?'
                },
                revelation: {
                    title: 'üí° The Powerful Insight',
                    insight: 'Most of us operate on autopilot, reacting before knowing our true inner state.\nThis leads to regrettable words and actions.\nA brief check-in restores choice and wisdom.',
                    analogy: {
                        title: 'üöó Driving Without Checking the Dashboard',
                        text: 'You wouldn\'t know if fuel is low, engine overheating, or oil pressure dropping.\nCheck-In is glancing at your internal dashboard before deciding how to proceed.'
                    },
                    skillExplained: 'Check-In means taking 5‚Äì10 seconds to scan: mood, body tension, energy level, urges ‚Äî then responding intentionally.'
                },
                modeA: {
                    title: '‚ùå Autopilot Mode',
                    emoji: 'ü§ñ',
                    steps: [
                        'Trigger appears',
                        'React instantly from habit',
                        'Miss internal warning signs',
                        'Later regret words or actions',
                        'Feel out of control'
                    ],
                    feeling: 'üò¨ Reactive, regretful, powerless'
                },
                modeB: {
                    title: '‚úÖ Aware Mode',
                    emoji: 'üß≠',
                    steps: [
                        'Trigger appears',
                        'Pause for 10 seconds',
                        'Scan body, mood, energy',
                        'Choose response based on data',
                        'Act intentionally'
                    ],
                    feeling: 'üéØ Grounded, wise, in control'
                },
                worksheet: [
                    { q: 'What automatic response did you give?', type: 'text' },
                    { q: 'Now pause and check: What is your actual mood right now? (1‚Äì10 calm to intense)', type: 'slider', min: 1, max: 10 },
                    { q: 'Where in your body do you feel any tension or sensation?', type: 'textarea' },
                    { q: 'What is your energy level right now? (1‚Äì10 low to high)', type: 'slider', min: 1, max: 10 }
                ],
                realWorld: {
                    mission: 'Do three quick check-ins today before responding to anything potentially emotional.',
                    examples: [
                        'Before replying to a message',
                        'Before speaking in conversation',
                        'Before making a decision when stressed'
                    ],
                    trackerHint: 'Complete 3+ check-ins today'
                },
                badge: { emoji: 'üß≠', name: 'Inner Compass', color: 'teal' }
            }
        ];

        const shopItems = [
            { id: 'theme_ocean', name: 'üåä Ocean Calm', cost: 150, type: 'theme', value: 'ocean' },
            { id: 'theme_sunset', name: 'üåÖ Sunset Glow', cost: 150, type: 'theme', value: 'sunset' },
            { id: 'theme_forest', name: 'üå≤ Forest Peace', cost: 150, type: 'theme', value: 'forest' },
            { id: 'theme_midnight', name: 'üåô Midnight Depth', cost: 200, type: 'theme', value: 'midnight' },
            { id: 'theme_rose', name: 'üåπ Rose Warmth', cost: 200, type: 'theme', value: 'rose' },
            { id: 'avatar_zen', name: 'üßò Zen Master', cost: 75, type: 'avatar', value: 'üßò' },
            { id: 'avatar_star', name: '‚≠ê Shining Star', cost: 75, type: 'avatar', value: '‚≠ê' },
            { id: 'avatar_fire', name: 'üî• Inner Fire', cost: 100, type: 'avatar', value: 'üî•' },
            { id: 'avatar_brain', name: 'üß† Wise Mind', cost: 100, type: 'avatar', value: 'üß†' },
            { id: 'avatar_heart', name: 'üíñ Open Heart', cost: 100, type: 'avatar', value: 'üíñ' },
            { id: 'avatar_lightning', name: '‚ö° Clear Focus', cost: 125, type: 'avatar', value: '‚ö°' },
            { id: 'avatar_crown', name: 'üëë Mastery', cost: 150, type: 'avatar', value: 'üëë' }
        ];

        // ====== OPTIMIZED FUNCTIONS ======
        function updateState(newState) {
            state = { ...state, ...newState };
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(render, 16);
        }

        // OPTIMIZED: Local cache only - NO RE-RENDER on typing
        function updateWorksheetData(key, value) {
            // ONLY update cache - NO STATE UPDATE = NO RE-RENDER
            textareaCache[key] = value;
        }

        // NEW: Sync cached data to state (call when leaving field or step)
        function syncWorksheetData() {
            if (Object.keys(textareaCache).length > 0) {
                updateState({ 
                    worksheetData: { ...state.worksheetData, ...textareaCache } 
                });
            }
        }

        // NEW: Get current value (checks cache first, then state)
        function getWorksheetValue(key) {
            return textareaCache[key] || state.worksheetData[key] || '';
        }

        function earnCoins(amount) {
            updateState({
                coinAmount: amount,
                showCoinAnimation: true,
                coins: state.coins + amount,
                user: { ...state.user, xp: state.user.xp + amount * 2 }
            });
            setTimeout(() => updateState({ showCoinAnimation: false }), 1500);
        }

        function showPurchaseModal(title, message) {
            document.getElementById('purchaseTitle').textContent = title;
            document.getElementById('purchaseMessage').textContent = message;
            document.getElementById('purchaseModal').classList.remove('hidden');
        }

        function closePurchaseModal() {
            document.getElementById('purchaseModal').classList.add('hidden');
        }

        function buyItem(item) {
            if (isOwned(item)) {
                if (item.type === 'theme') {
                    updateState({ user: { ...state.user, theme: item.value } });
                    showPurchaseModal('Theme Equipped!', `You're now using the ${item.name} theme.`);
                }
                if (item.type === 'avatar') {
                    updateState({ user: { ...state.user, avatar: item.value } });
                    showPurchaseModal('Avatar Equipped!', `You're now using the ${item.name} avatar.`);
                }
                return true;
            }

            if (state.coins >= item.cost) {
                updateState({ 
                    coins: state.coins - item.cost,
                    lastPurchase: item,
                    purchaseHistory: [...state.purchaseHistory, {
                        ...item,
                        date: new Date().toISOString()
                    }]
                });
                
                if (item.type === 'theme') {
                    updateState({
                        inventory: { ...state.inventory, themes: [...state.inventory.themes, item.value] },
                        user: { ...state.user, theme: item.value }
                    });
                } else if (item.type === 'avatar') {
                    updateState({
                        inventory: { ...state.inventory, avatars: [...state.inventory.avatars, item.value] },
                        user: { ...state.user, avatar: item.value }
                    });
                }
                
                if (state.unreadShopItems > 0) {
                    updateState({ unreadShopItems: state.unreadShopItems - 1 });
                }
                
                showPurchaseModal('Purchase Successful!', `You bought ${item.name} for ${item.cost} coins. Enjoy your new item!`);
                return true;
            } else {
                const needed = item.cost - state.coins;
                showPurchaseModal('Not Enough Coins', `You need ${needed} more coins to purchase ${item.name}. Complete more mindfulness practices to earn coins!`);
                return false;
            }
        }

        function isOwned(item) {
            return item.type === 'theme' ? state.inventory.themes.includes(item.value) : state.inventory.avatars.includes(item.value);
        }

        function startSkill(id) {
            const skill = skills.find(s => s.id === id);
            if (skill) {
                // Clear cache when starting new skill
                textareaCache = {};
                
                updateState({
                    activeSkill: skill,
                    currentStep: 'intro',
                    worksheetData: {},
                    screen: 'skill'
                });
            }
        }

        function handleShopItem(id) {
            const item = shopItems.find(i => i.id === id);
            if (item) {
                buyItem(item);
            }
        }

        function completeStep() {
            const steps = ['intro', 'experience', 'revelation', 'modeA', 'modeB', 'worksheet', 'mission', 'complete'];
            const currentIndex = steps.indexOf(state.currentStep);

            // Sync any unsaved worksheet data before moving steps
            syncWorksheetData();

            const rewards = { intro: 10, experience: 15, revelation: 20, modeA: 10, modeB: 25, worksheet: 40, mission: 100 };
            if (rewards[state.currentStep]) earnCoins(rewards[state.currentStep]);

            if (state.currentStep === 'mission' && state.activeSkill && !state.completedSkills.includes(state.activeSkill.id)) {
                const badge = state.activeSkill.badge;
                updateState({
                    completedSkills: [...state.completedSkills, state.activeSkill.id],
                    inventory: { ...state.inventory, badges: [...state.inventory.badges, badge] },
                    user: { ...state.user, totalPractices: state.user.totalPractices + 1, level: Math.floor((state.user.totalPractices + 1) / 3) + 1 }
                });
            }

            if (currentIndex < steps.length - 1) updateState({ currentStep: steps[currentIndex + 1] });
        }

        // FIX: Add scroll to top on navigation
        function navigateTo(screen) {
            window.scrollTo(0, 0); // ‚Üê THIS FIXES THE SCROLL ISSUE
            updateState({ screen });
        }

        function renderBottomNav() {
            const isSkill = state.screen === 'skill';
            return `
                <div class="bottom-nav fixed bottom-0 left-0 right-0 z-40">
                    <div class="max-w-md mx-auto flex items-center justify-around py-3">
                        <button onclick="navigateTo('home')" class="flex flex-col items-center gap-1 px-6 py-2 transition-smooth">
                            <div class="text-2xl">üè†</div>
                            <span class="text-xs font-medium ${state.screen === 'home' ? 'text-purple-600 font-bold' : 'text-gray-600'}">Home</span>
                        </button>
                        <button onclick="navigateTo('home')" class="flex flex-col items-center gap-1 px-6 py-2 transition-smooth">
                            <div class="text-2xl">${isSkill ? 'üéØ' : 'üß†'}</div>
                            <span class="text-xs font-bold text-purple-600">Skills</span>
                        </button>
                        <button onclick="navigateTo('shop')" class="flex flex-col items-center gap-1 px-6 py-2 relative transition-smooth">
                            ${state.unreadShopItems > 0 ? `<span class="nav-badge">${state.unreadShopItems}</span>` : ''}
                            <div class="text-2xl">üõçÔ∏è</div>
                            <span class="text-xs font-medium ${state.screen === 'shop' ? 'text-purple-600 font-bold' : 'text-gray-600'}">Shop</span>
                        </button>
                        <button onclick="navigateTo('profile')" class="flex flex-col items-center gap-1 px-6 py-2 relative transition-smooth">
                            ${state.inventory.badges.length > 0 ? `<span class="nav-badge">${state.inventory.badges.length}</span>` : ''}
                            <div class="text-2xl">üë§</div>
                            <span class="text-xs font-medium ${state.screen === 'profile' ? 'text-purple-600 font-bold' : 'text-gray-600'}">Profile</span>
                        </button>
                    </div>
                </div>
            `;
        }

        // Render screens
        function renderHomeScreen() {
            const themeClass = `theme-${state.user.theme}`;
            const completed = state.completedSkills.length;
            const progress = Math.round((completed / skills.length) * 100);

            return `
                <div class="min-h-screen ${themeClass} safe-top pb-20">
                    <div class="max-w-md mx-auto p-5">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-full bg-white/20 flex items-center justify-center text-3xl animate-float">
                                    ${state.user.avatar}
                                </div>
                                <div>
                                    <p class="text-white/90 text-sm">Welcome back,</p>
                                    <h2 class="text-white font-bold text-lg">${state.user.name}</h2>
                                    <p class="text-white/80 text-xs">Level ${state.user.level} ‚Ä¢ ${state.user.xp} XP</p>
                                </div>
                            </div>
                            <div class="bg-white/20 px-4 py-2 rounded-full flex items-center gap-2">
                                <span class="text-xl">ü™ô</span>
                                <span class="text-white font-bold text-lg">${state.coins}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div class="bg-white/20 rounded-2xl p-4 text-center">
                                <p class="text-3xl font-bold text-white">${completed}/${skills.length}</p>
                                <p class="text-white/80 text-xs mt-1">Skills Mastered</p>
                            </div>
                            <div class="bg-white/20 rounded-2xl p-4 text-center">
                                <p class="text-3xl font-bold text-white">${state.user.streak}</p>
                                <p class="text-white/80 text-xs mt-1">Day Streak</p>
                            </div>
                        </div>

                        <div class="bg-white/20 rounded-2xl p-5 mb-6">
                            <div class="flex justify-between text-white mb-2">
                                <p class="font-bold text-sm">Journey Progress</p>
                                <p class="font-bold text-sm">${progress}%</p>
                            </div>
                            <div class="h-3 bg-white/30 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-emerald-400 to-teal-500 rounded-full transition-all duration-1000" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <h3 class="text-white font-bold text-xl mb-4">7 Core Mindfulness Skills</h3>
                        <div class="space-y-3">
                            ${skills.map(skill => {
                                const done = state.completedSkills.includes(skill.id);
                                return `
                                    <button onclick="startSkill('${skill.id}')" class="w-full bg-white rounded-2xl p-4 text-left hover:shadow-lg transition-smooth ${done ? 'border-2 border-green-400' : ''}">
                                        <div class="flex gap-3">
                                            <div class="w-14 h-14 bg-gradient-to-br ${skill.color} rounded-xl flex items-center justify-center text-2xl flex-shrink-0">
                                                ${skill.icon}
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <h4 class="text-base font-bold text-gray-800">${skill.name}</h4>
                                                    ${done ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold">‚úì</span>' : ''}
                                                </div>
                                                <p class="text-gray-700 text-sm font-medium mb-1">${skill.tagline}</p>
                                                <p class="text-gray-600 text-xs">${skill.simpleExplain}</p>
                                            </div>
                                            <div class="self-center text-xl text-gray-400">${done ? 'üéâ' : '‚ñ∂Ô∏è'}</div>
                                        </div>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ${renderBottomNav()}
                </div>
            `;
        }

        function renderSkillScreen() {
            if (!state.activeSkill) return renderHomeScreen();
            const skill = state.activeSkill;
            const themeClass = `theme-${state.user.theme}`;
            const steps = ['intro', 'experience', 'revelation', 'modeA', 'modeB', 'worksheet', 'mission', 'complete'];
            const idx = steps.indexOf(state.currentStep);

            let content = '';

            if (state.currentStep === 'intro') {
                content = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r ${skill.color} rounded-2xl p-6 text-white text-center">
                            <div class="text-5xl mb-4">${skill.icon}</div>
                            <h2 class="text-2xl font-black mb-2">${skill.name}</h2>
                            <p class="text-lg opacity-90 mb-4">${skill.tagline}</p>
                            <div class="bg-white/20 rounded-xl p-4">
                                <p class="text-base leading-relaxed">${skill.simpleExplain}</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-6">
                            <div class="flex items-start gap-4">
                                <div class="text-3xl">üí°</div>
                                <div>
                                    <h3 class="font-bold text-lg mb-2">How This Training Works</h3>
                                    <p class="text-gray-700 leading-relaxed">You'll first <strong>experience</strong> the old habitual way vs the new skillful way. Then we'll reveal the insight and science behind it. Deep reflection and real-world practice lock it in.</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="completeStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg transition-smooth">
                            Begin Experience ‚Üí Earn 10 Coins
                        </button>
                    </div>
                `;
            } else if (state.currentStep === 'experience') {
                content = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r ${skill.color} rounded-2xl p-6 text-white">
                            <div class="text-5xl mb-3">üß™</div>
                            <h2 class="text-xl font-bold mb-2">${skill.experienceFirst.title}</h2>
                            <p class="opacity-90">${skill.experienceFirst.subtitle}</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 space-y-4">
                            ${skill.experienceFirst.instructions.map((inst, i) => `
                                <div class="flex gap-4">
                                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-white font-bold text-lg flex-shrink-0">
                                        ${i + 1}
                                    </div>
                                    <p class="text-gray-700 pt-2 leading-relaxed">${inst}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div class="bg-white rounded-2xl p-6">
                            <p class="text-lg font-bold text-gray-800 mb-4">${skill.experienceFirst.prompt}</p>
                            <textarea 
                                class="w-full p-4 rounded-xl border-2 border-amber-300 focus:border-amber-500 no-freeze" 
                                rows="4" 
                                placeholder="Be completely honest ‚Äî what did you notice?"
                                oninput="updateWorksheetData('exp', this.value)"
                                onblur="syncWorksheetData()"
                            >${getWorksheetValue('exp')}</textarea>
                        </div>
                        <button onclick="completeStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg transition-smooth">
                            Continue ‚Üí Earn 15 Coins
                        </button>
                    </div>
                `;
            } else if (state.currentStep === 'revelation') {
                content = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-amber-400 to-orange-500 rounded-2xl p-6 text-white">
                            <div class="text-5xl mb-3">üí°</div>
                            <h2 class="text-xl font-bold">${skill.revelation.title}</h2>
                        </div>
                        <div class="bg-white rounded-2xl p-6">
                            <p class="text-gray-700 whitespace-pre-line leading-relaxed">${skill.revelation.insight}</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-6 border-2 border-blue-200">
                            <h3 class="text-lg font-bold text-blue-900 mb-2">${skill.revelation.analogy.title}</h3>
                            <p class="text-blue-800 whitespace-pre-line leading-relaxed">${skill.revelation.analogy.text}</p>
                        </div>
                        <button onclick="completeStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg transition-smooth">
                            I Get It ‚Üí Earn 20 Coins
                        </button>
                    </div>
                `;
            } else if (state.currentStep === 'modeA') {
                content = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-red-500 to-orange-600 rounded-2xl p-6 text-white">
                            <div class="text-5xl mb-3">${skill.modeA.emoji}</div>
                            <h2 class="text-xl font-bold">${skill.modeA.title}</h2>
                            <p class="opacity-90 text-sm">The old, painful habit most of us default to</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 space-y-4">
                            ${skill.modeA.steps.map((step, i) => `
                                <div class="flex gap-4 p-3 bg-red-50 rounded-xl">
                                    <div class="w-8 h-8 bg-red-200 rounded-full flex items-center justify-center text-red-700 font-bold">
                                        ${i + 1}
                                    </div>
                                    <p class="text-gray-800 leading-relaxed">${step}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div class="bg-red-50 rounded-2xl p-4 border-2 border-red-300">
                            <p class="font-bold text-red-900 mb-1">Feels like:</p>
                            <p class="text-red-800">${skill.modeA.feeling}</p>
                        </div>
                        <button onclick="completeStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg transition-smooth">
                            Show Me the Better Way ‚Üí Earn 10 Coins
                        </button>
                    </div>
                `;
            } else if (state.currentStep === 'modeB') {
                content = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r ${skill.color} rounded-2xl p-6 text-white">
                            <div class="text-5xl mb-3">${skill.modeB.emoji}</div>
                            <h2 class="text-xl font-bold">${skill.modeB.title}</h2>
                            <p class="opacity-90 text-sm">The skillful, freeing approach</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 space-y-4">
                            ${skill.modeB.steps.map((step, i) => `
                                <div class="flex gap-4 p-3 bg-green-50 rounded-xl">
                                    <div class="w-8 h-8 bg-green-200 rounded-full flex items-center justify-center text-green-700 font-bold">
                                        ${i + 1}
                                    </div>
                                    <p class="text-gray-800 leading-relaxed">${step}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div class="bg-green-50 rounded-2xl p-4 border-2 border-green-300">
                            <p class="font-bold text-green-900 mb-1">Feels like:</p>
                            <p class="text-green-800">${skill.modeB.feeling}</p>
                        </div>
                        <button onclick="completeStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg transition-smooth">
                            Try This Way Now ‚Üí Earn 25 Coins
                        </button>
                    </div>
                `;
            } else if (state.currentStep === 'worksheet') {
                content = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-6 text-white">
                            <div class="text-5xl mb-3">üìù</div>
                            <h2 class="text-xl font-bold">Deep Reflection Time</h2>
                            <p class="opacity-90 text-sm">This is where the learning becomes permanent</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 space-y-6">
                            ${skill.worksheet.map((q, i) => {
                                const key = `q${i}`;
                                const val = getWorksheetValue(key);
                                return `
                                    <div>
                                        <p class="font-bold text-gray-800 mb-3">${q.q}</p>
                                        ${q.type === 'textarea' ? `
                                            <textarea 
                                                class="w-full p-4 rounded-xl border-2 border-gray-300 focus:border-purple-500 no-freeze" 
                                                rows="3" 
                                                placeholder="Write freely..."
                                                oninput="updateWorksheetData('${key}', this.value)"
                                                onblur="syncWorksheetData()"
                                            >${val}</textarea>
                                        ` : q.type === 'text' ? `
                                            <input 
                                                type="text" 
                                                class="w-full p-4 rounded-xl border-2 border-gray-300 focus:border-purple-500" 
                                                value="${val}" 
                                                oninput="updateWorksheetData('${key}', this.value)"
                                                onblur="syncWorksheetData()" 
                                            />
                                        ` : `
                                            <div>
                                                <input 
                                                    type="range" 
                                                    min="${q.min}" 
                                                    max="${q.max}" 
                                                    class="w-full h-3 rounded-lg" 
                                                    value="${val || 5}" 
                                                    oninput="updateWorksheetData('${key}', this.value); syncWorksheetData()" 
                                                />
                                                <div class="flex justify-between mt-2">
                                                    <span class="text-gray-600">${q.min}</span>
                                                    <span class="font-black text-purple-600 text-xl">${val || 5}</span>
                                                    <span class="text-gray-600">${q.max}</span>
                                                </div>
                                            </div>
                                        `}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button onclick="completeStep()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg transition-smooth">
                            Submit Reflection ‚Üí Earn 40 Coins
                        </button>
                    </div>
                `;
            } else if (state.currentStep === 'mission') {
                content = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-6 text-white">
                            <div class="text-5xl mb-3">üåç</div>
                            <h2 class="text-xl font-bold">Your Real-World Mission</h2>
                            <p class="opacity-90 text-sm">Take this skill into your day and feel the difference</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 space-y-6">
                            <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-6 border-2 border-amber-300">
                                <p class="font-bold text-gray-800">${skill.realWorld.mission}</p>
                            </div>
                            <div class="space-y-3">
                                <p class="font-bold text-gray-700">Helpful examples:</p>
                                ${skill.realWorld.examples.map(ex => `
                                    <div class="p-4 bg-gray-50 rounded-xl">
                                        ${ex}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="text-center">
                                <p class="text-gray-600 italic mb-4 text-sm">${skill.realWorld.trackerHint || 'Practice multiple times to build the habit'}</p>
                                <div class="grid grid-cols-6 gap-2 max-w-xs mx-auto">
                                    ${Array(12).fill().map(() => `
                                        <div class="aspect-square bg-gray-200 rounded-lg border-2 border-dashed border-gray-400"></div>
                                    `).join('')}
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Tap to mark each practice</p>
                            </div>
                        </div>
                        <button onclick="completeStep()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg transition-smooth flex items-center justify-center gap-3">
                            <span class="text-2xl">üèÜ</span>
                            Master This Skill ‚Üí Earn 100 Coins + Badge
                        </button>
                    </div>
                `;
            } else if (state.currentStep === 'complete') {
                content = `
                    <div class="space-y-6 text-center">
                        <div class="bg-gradient-to-r from-yellow-400 via-orange-500 to-pink-600 rounded-2xl p-8 text-white">
                            <div class="text-6xl mb-4">üèÜ</div>
                            <h2 class="text-2xl font-black mb-4">Skill Mastered!</h2>
                            <p class="mb-6">You earned coins throughout + a permanent badge</p>
                            <div class="inline-block bg-white/30 px-6 py-3 rounded-2xl">
                                <span class="text-4xl mr-3">${skill.badge.emoji}</span>
                                <span class="text-xl font-black">${skill.badge.name}</span>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-6 space-y-4">
                            <h3 class="text-lg font-bold text-gray-800">What You've Gained</h3>
                            <div class="space-y-3 text-left text-gray-700">
                                <p>‚úì Directly experienced the painful habit vs the freeing skill</p>
                                <p>‚úì Understood the deep insight and science behind it</p>
                                <p>‚úì Reflected deeply to make it stick</p>
                                <p>‚úì Received a real-world mission to integrate it</p>
                                <p>‚úì Earned the ${skill.badge.emoji} <strong>${skill.badge.name}</strong> badge forever</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="navigateTo('home')" class="py-4 rounded-2xl border-2 border-purple-600 text-purple-600 font-bold text-lg hover:bg-purple-50 transition-smooth">
                                ‚Üê Home
                            </button>
                            <button onclick="navigateTo('shop')" class="py-4 rounded-2xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-lg shadow-lg transition-smooth">
                                Spend Coins ‚Üí
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="min-h-screen ${themeClass} pb-32 safe-top">
                    <div class="max-w-md mx-auto p-4">
                        <div class="bg-white/90 rounded-2xl p-4 sticky top-0 z-10 mb-3">
                            <div class="flex items-center justify-between mb-4">
                                <button onclick="navigateTo('home')" class="text-2xl">‚Üê</button>
                                <h1 class="text-lg font-bold text-gray-800">${skill.name}</h1>
                                <div class="bg-white/20 px-3 py-2 rounded-full flex items-center gap-2">
                                    <span class="text-xl">ü™ô</span>
                                    <span class="text-gray-800 font-bold">${state.coins}</span>
                                </div>
                            </div>
                            <div class="flex gap-1 mb-2">
                                ${steps.map((_, i) => `
                                    <div class="flex-1 h-2 rounded-full ${i <= idx ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-gray-300'}"></div>
                                `).join('')}
                            </div>
                            <p class="text-gray-600 text-xs text-center">Step ${idx + 1} of ${steps.length}</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6">
                            ${content}
                        </div>
                    </div>
                    ${state.showCoinAnimation ? `
                        <div class="fixed inset-0 pointer-events-none flex items-center justify-center z-50">
                            <div class="animate-coin-pop text-center">
                                <div class="text-7xl mb-3">ü™ô</div>
                                <div class="text-4xl font-black text-yellow-400">+${state.coinAmount}</div>
                                <p class="text-xl text-white mt-3 font-bold">Coins Earned!</p>
                            </div>
                        </div>
                    ` : ''}
                    ${renderBottomNav()}
                </div>
            `;
        }

        function renderShopScreen() {
            const themeClass = `theme-${state.user.theme}`;
            const ownedThemes = state.inventory.themes.length;
            const ownedAvatars = state.inventory.avatars.length;
            
            return `
                <div class="min-h-screen ${themeClass} pb-20 safe-top">
                    <div class="max-w-md mx-auto p-4">
                        <div class="bg-black/20 rounded-2xl p-6 mb-4">
                            <div class="flex items-center justify-between mb-4">
                                <button onclick="navigateTo('home')" class="text-2xl text-white">‚Üê</button>
                                <div>
                                    <h1 class="text-xl font-black text-white">Reward Shop</h1>
                                    <p class="text-white/80 text-xs mt-1">${ownedThemes} themes ‚Ä¢ ${ownedAvatars} avatars owned</p>
                                </div>
                                <div class="bg-white/20 px-3 py-2 rounded-full flex items-center gap-2">
                                    <span class="text-xl">ü™ô</span>
                                    <span class="text-white font-bold">${state.coins}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-black/20 rounded-2xl p-6 space-y-8">
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-lg font-black text-white">üé® Themes</h2>
                                    <span class="bg-white/20 px-3 py-1 rounded-full text-white text-xs font-bold">${ownedThemes}/5</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    ${shopItems.filter(i => i.type === 'theme').map(item => {
                                        const owned = isOwned(item);
                                        const active = state.user.theme === item.value;
                                        return `
                                            <button onclick="handleShopItem('${item.id}')" class="rounded-2xl overflow-hidden border-2 transition-all ${active ? 'border-yellow-400 shadow-lg' : owned ? 'border-green-400' : 'border-white/30'}">
                                                <div class="h-32 theme-${item.value} relative">
                                                    ${active ? `<div class="absolute top-2 right-2 bg-yellow-400 text-gray-900 px-2 py-1 rounded-full text-xs font-bold">ACTIVE</div>` : ''}
                                                    ${owned && !active ? `<div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-bold">OWNED</div>` : ''}
                                                </div>
                                                <div class="p-3 bg-black/40">
                                                    <p class="text-white font-bold text-center text-sm mb-1">${item.name}</p>
                                                    ${owned ? 
                                                        `<p class="text-green-300 text-center text-xs font-bold">‚úì Equippable</p>` : 
                                                        `<div class="text-center">
                                                            <p class="text-yellow-300 font-bold text-sm mb-1">${item.cost} ü™ô</p>
                                                            ${state.coins >= item.cost ? 
                                                                `<p class="text-green-300 text-xs font-bold">Can afford</p>` : 
                                                                `<p class="text-red-300 text-xs font-bold">Need ${item.cost - state.coins} more</p>`
                                                            }
                                                        </div>`
                                                    }
                                                </div>
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-lg font-black text-white">üë§ Avatars</h2>
                                    <span class="bg-white/20 px-3 py-1 rounded-full text-white text-xs font-bold">${ownedAvatars}/7</span>
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    ${shopItems.filter(i => i.type === 'avatar').map(item => {
                                        const owned = isOwned(item);
                                        const active = state.user.avatar === item.value;
                                        return `
                                            <button onclick="handleShopItem('${item.id}')" class="p-4 rounded-2xl bg-black/40 border-2 transition-all text-center ${active ? 'border-yellow-400 shadow-lg' : owned ? 'border-green-400' : 'border-white/30'}">
                                                <div class="text-4xl mb-2">${item.value}</div>
                                                <p class="text-white font-bold text-xs mb-1">${item.name}</p>
                                                ${owned ? 
                                                    `<p class="text-green-300 text-xs font-bold">‚úì</p>` : 
                                                    `<div>
                                                        <p class="text-yellow-300 font-bold text-sm mb-1">${item.cost} ü™ô</p>
                                                        ${state.coins >= item.cost ? 
                                                            `<p class="text-green-300 text-xs font-bold">‚úì</p>` : 
                                                            `<p class="text-red-300 text-xs font-bold">‚úó</p>`
                                                        }
                                                    </div>`
                                                }
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <div class="text-center pt-4 border-t border-white/20">
                                <p class="text-white/70 mb-3 text-sm">Want more coins?</p>
                                <button onclick="navigateTo('home')" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-2xl text-sm">
                                    Practice Mindfulness Skills ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                    ${renderBottomNav()}
                </div>
            `;
        }

        function renderProfileScreen() {
            const themeClass = `theme-${state.user.theme}`;
            const completed = state.completedSkills.length;
            return `
                <div class="min-h-screen ${themeClass} pb-20 safe-top">
                    <div class="max-w-md mx-auto p-4">
                        <div class="bg-black/20 rounded-2xl p-6 mb-4">
                            <div class="flex items-center justify-between">
                                <button onclick="navigateTo('home')" class="text-2xl text-white">‚Üê</button>
                                <h1 class="text-xl font-black text-white">Your Profile</h1>
                                <div></div>
                            </div>
                        </div>
                        <div class="bg-black/20 rounded-2xl p-6 space-y-8">
                            <div class="text-center">
                                <div class="w-32 h-32 rounded-full bg-white/20 mx-auto mb-4 flex items-center justify-center text-6xl animate-float">
                                    ${state.user.avatar}
                                </div>
                                <h2 class="text-2xl font-black text-white mb-2">${state.user.name}</h2>
                                <div class="bg-white/20 px-4 py-2 rounded-full inline-flex items-center gap-2">
                                    <span class="text-xl text-yellow-400">‚òÖ</span>
                                    <span class="text-white font-bold">Level ${state.user.level}</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-white/20 rounded-2xl p-4 text-center">
                                    <p class="text-3xl font-black text-white">${completed}/7</p>
                                    <p class="text-white/80 mt-1 text-xs">Skills Mastered</p>
                                </div>
                                <div class="bg-white/20 rounded-2xl p-4 text-center">
                                    <p class="text-3xl font-black text-white">${state.coins}</p>
                                    <p class="text-white/80 mt-1 text-xs">Total Coins</p>
                                </div>
                                <div class="bg-white/20 rounded-2xl p-4 text-center">
                                    <p class="text-3xl font-black text-white">${state.user.xp}</p>
                                    <p class="text-white/80 mt-1 text-xs">Lifetime XP</p>
                                </div>
                                <div class="bg-white/20 rounded-2xl p-4 text-center">
                                    <p class="text-3xl font-black text-white">${state.user.streak}</p>
                                    <p class="text-white/80 mt-1 text-xs">Current Streak</p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-black text-white mb-4">üèÜ Your Badge Collection</h3>
                                ${state.inventory.badges.length > 0 ? `
                                    <div class="grid grid-cols-3 gap-3">
                                        ${state.inventory.badges.map(b => `
                                            <div class="bg-white/20 rounded-2xl p-4 text-center">
                                                <div class="text-4xl mb-2">${b.emoji}</div>
                                                <p class="text-white font-bold text-xs">${b.name}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center py-8">
                                        <div class="text-6xl mb-4 opacity-50">üèÜ</div>
                                        <p class="text-white/80 mb-4">Complete skills to earn your first badge!</p>
                                        <button onclick="navigateTo('home')" class="px-6 py-3 bg-white/20 rounded-2xl text-white font-bold text-sm">
                                            Start Training
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    ${renderBottomNav()}
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            if (state.screen === 'skill') app.innerHTML = renderSkillScreen();
            else if (state.screen === 'shop') app.innerHTML = renderShopScreen();
            else if (state.screen === 'profile') app.innerHTML = renderProfileScreen();
            else app.innerHTML = renderHomeScreen();
        }

        // Initialize
        render();
    </script>
</body>
</html>
